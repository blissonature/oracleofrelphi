function pad2(n){ return String(n).padStart(2,'0'); }
function fmtDateParam(tz, d){
  const p = zonedParts(tz, d);
  return `${p.year}-${p.month}-${p.day}`;               // YYYY-MM-DD
}
function fmtTimeParam(tz, d){
  const p = zonedParts(tz, d);
  return `${p.hour}:${p.minute}`;                      // HH:MM (24h)
}
$("#copyLinkBtn").onclick = async () => {
  const url = new URL(location.href);
  const q = url.searchParams;
  q.set('lat', state.lat.toFixed(6));
  q.set('lon', state.lon.toFixed(6));
  q.set('tz', state.tz);
  q.set('mode', state.useCustom ? 'custom' : 'auto');
  q.set('date', fmtDateParam(state.tz, state.when));
  q.set('time', fmtTimeParam(state.tz, state.when));
  try { await navigator.clipboard.writeText(url.toString()); alert("Link copied!"); }
  catch { prompt("Copy this URL:", url.toString()); }
};

// on load, hydrate from params
(function hydrateFromURL(){
  const q = new URLSearchParams(location.search);
  if (q.has('lat')) state.lat = +q.get('lat');
  if (q.has('lon')) state.lon = +q.get('lon');
  if (q.has('tz'))  state.tz  = q.get('tz');
  if (q.get('mode') === 'custom' && q.has('date') && q.has('time')) {
    const [Y,M,D] = q.get('date').split('-').map(Number);
    const [h,m]   = q.get('time').split(':').map(Number);
    // Build a Date matching the zoned components (in system clock)
    state.when = new Date(Y, M-1, D, h, m, 0);
    state.useCustom = true;
  }
  buildScheduleForState(state);
  renderAll();
})();
