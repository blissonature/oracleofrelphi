<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planetary Hours (No-Frills)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 2rem; }
    .card { max-width: 560px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .hrs { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; margin-top: 12px; }
    .hr { padding: 6px 8px; border-radius: 8px; border: 1px solid #eee; }
    .hr.now { border-color: #999; font-weight: 600; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .tiny { font-size: 12px; color: #666; }
    .pill { padding: 4px 8px; border: 1px solid #ddd; border-radius: 999px; }
    .bar { height: 8px; background: #eee; border-radius: 999px; overflow: hidden; }
    .bar > div { height: 100%; width: 0%; background: #000; }
    button, input, select { padding: 6px 8px; }
    label { font-size: 12px; color: #444; }

    /* Nav links */
    .navlink {
      text-decoration: none; padding: 4px 10px; border: 1px solid #ddd;
      border-radius: 999px; font-size: 14px; color: #333;
    }
    .navlink:hover { background: #f5f5f5; }

    /* Moving ruler */
    .ruler-wrap { margin:14px 0 6px; }
    .ruler {
      position: relative; height: 40px; border: 1px solid #eee; border-radius: 999px;
      background: linear-gradient(90deg, #fafafa, #f3f3f3);
      overflow: hidden;
    }
    .ruler-track {
      position: absolute; inset: 0; pointer-events: none;
      background: repeating-linear-gradient(
        to right,
        transparent 0, transparent 9%,
        rgba(0,0,0,0.06) 9%, rgba(0,0,0,0.06) 9.5%
      );
      mask-image: linear-gradient(90deg, transparent 0, #000 8%, #000 92%, transparent 100%);
    }
    .chip {
      position: absolute; top: 50%; transform: translate(-50%, -50%);
      padding: 6px 12px; border-radius: 999px; border: 1px solid #ddd;
      background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      transition: left 1s linear;
      white-space: nowrap; font-weight: 600;
    }
    .chip-ghost {
      opacity: 1; transition: left .6s ease, opacity .6s ease;
      background: #fff; border-color: #eee; font-weight: 500;
    }

    /* Planet line + clock */
    #planetInfo { font-size: 16px; color:#333; margin-top:4px; }
    #planetInfo .sym { font-size: 20px; margin-right:6px; }
    #clock { margin-top:4px; }
  </style>
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="tiny">Current Planetary Hour</div>
        <div id="current" style="font-size: 28px; font-weight: 700;">–</div>
        <div id="planetInfo" class="tiny"><span class="sym"></span><span class="about"></span></div>
        <div id="clock" class="mono tiny">–</div>

        <div class="row" style="margin-top:6px;">
          <span class="pill mono" id="range">–</span>
          <span class="pill mono" id="countdown">–</span>
          <span class="pill" id="nextPreview">Next: –</span>
          <span class="pill" id="weekday">–</span>
        </div>
      </div>

      <div>
        <div class="tiny">Location</div>
        <div class="row">
          <button id="geoBtn" title="Use browser location">Use my location</button>
          <div class="row">
            <label>Lat <input id="lat" size="8" /></label>
            <label>Lon <input id="lon" size="8" /></label>
            <button id="setBtn">Set</button>
          </div>
        </div>
        <div class="tiny mono" id="locEcho">–</div>

        <div class="row" style="margin-top:8px;">
          <label>Timezone
            <select id="tzSelect">
              <option value="America/Denver" data-lat="39.7392" data-lon="-104.9903">America/Denver (Denver)</option>
              <option value="America/Los_Angeles" data-lat="34.0522" data-lon="-118.2437">America/Los_Angeles (Los Angeles)</option>
              <option value="America/Phoenix" data-lat="33.4484" data-lon="-112.0740">America/Phoenix (Phoenix)</option>
              <option value="America/Chicago" data-lat="41.8781" data-lon="-87.6298">America/Chicago (Chicago)</option>
              <option value="America/New_York" data-lat="40.7128" data-lon="-74.0060">America/New_York (New York)</option>
              <option value="Europe/London" data-lat="51.5074" data-lon="-0.1278">Europe/London (London)</option>
              <option value="Europe/Paris" data-lat="48.8566" data-lon="2.3522">Europe/Paris (Paris)</option>
              <option value="Asia/Tokyo" data-lat="35.6762" data-lon="139.6503">Asia/Tokyo (Tokyo)</option>
              <option value="Australia/Sydney" data-lat="-33.8688" data-lon="151.2093">Australia/Sydney (Sydney)</option>
            </select>
          </label>
          <button id="useTzBtn" title="Use this timezone’s representative city">Use timezone</button>
        </div>

        <div class="row" style="margin-top:12px; flex-wrap:wrap; gap:8px;">
          <a href="about.html" class="navlink">About the Oracle</a>
          <a href="commune.html" class="navlink">Commune with the Oracle</a>
          <a href="donate.html" class="navlink">Donate</a>
        </div>
      </div>
    </div>

    <div class="ruler-wrap">
      <div class="tiny">Hour ruler</div>
      <div class="ruler" id="ruler">
        <div class="ruler-track"></div>
        <div class="chip" id="chipCurrent">–</div>
      </div>
    </div>

    <div style="margin:12px 0;">
      <div class="tiny">Progress</div>
      <div class="bar"><div id="progress"></div></div>
    </div>

    <div class="tiny" id="suninfo">–</div>
    <div class="hrs" id="list"></div>
  </div>

<script>
(function(){
  // Chaldean order & day rulers
  const ORDER = ["Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon"];
  const DAY_RULER = { 0:"Sun", 1:"Moon", 2:"Mars", 3:"Mercury", 4:"Jupiter", 5:"Venus", 6:"Saturn" };
  const WEEKDAY_NAME = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

  // Planet glyphs + essence
  const PLANET_INFO = {
    Sun:{symbol:"☉",about:"Ruler of Vitality & Purpose"},
    Moon:{symbol:"☽",about:"Ruler of Cycles & Emotion"},
    Mercury:{symbol:"☿",about:"Ruler of Thought & Exchange"},
    Venus:{symbol:"♀",about:"Ruler of Harmony & Affection"},
    Mars:{symbol:"♂",about:"Ruler of Energy & Action"},
    Jupiter:{symbol:"♃",about:"Ruler of Growth & Wisdom"},
    Saturn:{symbol:"♄",about:"Ruler of Structure & Time"}
  };

  // UI
  const elCurrent = document.getElementById('current');
  const elRange = document.getElementById('range');
  const elCountdown = document.getElementById('countdown');
  const elNextPreview = document.getElementById('nextPreview');
  const elWeekday = document.getElementById('weekday');
  const elList = document.getElementById('list');
  const elSuninfo = document.getElementById('suninfo');
  const elProgress = document.getElementById('progress');
  const elLat = document.getElementById('lat');
  const elLon = document.getElementById('lon');
  const elLocEcho = document.getElementById('locEcho');
  const elPlanetInfo = document.getElementById('planetInfo');
  const elClock = document.getElementById('clock');
  const tzSelect = document.getElementById('tzSelect');
  const useTzBtn = document.getElementById('useTzBtn');
  const geoBtn = document.getElementById('geoBtn');
  const setBtn = document.getElementById('setBtn');

  // Ruler
  const chip = document.getElementById('chipCurrent');
  const ruler = document.getElementById('ruler');

  // State
  let lat, lon, schedule=[], nextRecalcAt=0, tz="America/Denver";
  let lastPlanet=null, lastPct=0;

  // Helpers
  const pad2 = n => String(n).padStart(2,'0');
  const fmtInTZ = (d,tz) => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', timeZone:tz});
  const fmtClock = (d,tz) => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', timeZone:tz}); // no seconds

  function chaldeanSequence(startPlanet, len){
    const start = ORDER.indexOf(startPlanet);
    return Array.from({length:len}, (_,i)=>ORDER[(start+i)%ORDER.length]);
  }
  function tzWeekday(d,tz){
    const short = new Intl.DateTimeFormat('en-US',{timeZone:tz,weekday:'short'}).format(d);
    return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].indexOf(short);
  }
  function tzMidnightUTC(tz){
    const now = new Date();
    const parts = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(now).split('-').map(Number);
    return new Date(Date.UTC(parts[0], parts[1]-1, parts[2]));
  }

  function buildSchedule(localMidnightUTC, lat, lon){
    const t0 = SunCalc.getTimes(localMidnightUTC, lat, lon);
    if(!t0.sunrise || !t0.sunset) throw new Error("No sunrise/sunset.");
    const sunrise = t0.sunrise, sunset = t0.sunset;

    const tomorrowUTC = new Date(localMidnightUTC.getTime()+24*3600*1000);
    const t1 = SunCalc.getTimes(tomorrowUTC, lat, lon);
    const nextSunrise = t1.sunrise;

    const dayHour = (sunset - sunrise)/12;
    const nightHour = (nextSunrise - sunset)/12;

    const weekday = tzWeekday(sunrise, tz);
    const daySeq = chaldeanSequence(DAY_RULER[weekday], 12);
    const nightSeq = chaldeanSequence(ORDER[(ORDER.indexOf(daySeq[11])+1)%7], 12);

    const out=[];
    for(let i=0;i<12;i++){
      out.push({idx:i+1, planet:daySeq[i],
        start:new Date(sunrise.getTime()+i*dayHour),
        end:new Date(sunrise.getTime()+(i+1)*dayHour)});
    }
    for(let i=0;i<12;i++){
      out.push({idx:13+i, planet:nightSeq[i],
        start:new Date(sunset.getTime()+i*nightHour),
        end:new Date(sunset.getTime()+(i+1)*nightHour)});
    }

    nextRecalcAt = t1.sunrise.getTime();
    setTimeout(()=>init(lat,lon,true), Math.max(0,nextRecalcAt-Date.now()+100));
    return {out, sunrise, sunset, nextSunrise, weekday, weekdayName: WEEKDAY_NAME[weekday]};
  }

  function renderList(){
    elList.innerHTML = "";
    for(const h of schedule){
      const info = PLANET_INFO[h.planet];
      const div = document.createElement('div');
      div.className = 'hr';
      div.innerHTML = `<div><strong>${h.idx<=12?"Day":"Night"} ${(h.idx-1)%12+1}</strong> — ${info.symbol} ${h.planet}</div>
                       <div class="tiny mono">${fmtInTZ(h.start,tz)} – ${fmtInTZ(h.end,tz)}</div>`;
      elList.appendChild(div);
    }
  }

  function makeGhostChip(text, pct){
    const g = document.createElement('div');
    g.className = 'chip chip-ghost';
    g.textContent = text;
    g.style.left = pct+'%';
    ruler.appendChild(g);
    requestAnimationFrame(()=>{ g.style.left='-10%'; g.style.opacity='0'; });
    setTimeout(()=>g.remove(),650);
  }

  function updatePlanetInfo(p){ elPlanetInfo.innerHTML = `<span class="sym">${PLANET_INFO[p].symbol}</span><span class="about">${p} — ${PLANET_INFO[p].about}</span>`; }
  function updateNextPreview(p){ elNextPreview.textContent = `Next: ${PLANET_INFO[p].symbol} ${p}`; }
  function updateClockLine(){ elClock.textContent = fmtClock(new Date(), tz); }

  function updateNow(){
    if(!schedule.length) return;
    updateClockLine();

    const now = Date.now();
    let idx = schedule.findIndex(h => now>=h.start.getTime() && now<h.end.getTime());
    let current = (idx>=0)? schedule[idx] : null;

    // Safety: choose closest before-now slot if on a boundary
    if(!current){
      for(let i=schedule.length-1;i>=0;i--){ if(now>=schedule[i].start.getTime()){ idx=i; current=schedule[i]; break; } }
      if(!current){ idx=0; current=schedule[0]; } // absolute fallback
    }

    if(now >= nextRecalcAt-1000){ init(lat,lon,true); return; }

    const remain = current.end.getTime()-now;
    const hh = Math.floor(remain/3600000);
    const mm = Math.floor((remain%3600000)/60000);
    const ss = Math.floor((remain%60000)/1000);

    elCurrent.textContent = current.planet;
    updatePlanetInfo(current.planet);
    elRange.textContent = `${fmtInTZ(current.start,tz)}–${fmtInTZ(current.end,tz)}`;
    elWeekday.textContent = WEEKDAY_NAME[tzWeekday(current.start,tz)];
    elCountdown.textContent = `Next in ${hh?hh+":" : ""}${pad2(mm)}:${pad2(ss)}`;

    const nextIdx = (idx+1)%schedule.length;
    updateNextPreview(schedule[nextIdx].planet);

    const dur = current.end-current.start;
    const pct = 100*(1 - (remain/dur));
    elProgress.style.width = `${Math.max(0,Math.min(100,pct))}%`;

    const label = `${PLANET_INFO[current.planet].symbol} ${current.planet}`;
    if(lastPlanet && current.planet!==lastPlanet){ makeGhostChip(`${PLANET_INFO[lastPlanet].symbol} ${lastPlanet}`, lastPct); }
    chip.textContent = label;
    chip.style.left = `${Math.max(0,Math.min(100,pct))}%`;
    lastPlanet = current.planet; lastPct = pct;

    [...document.querySelectorAll('.hr')].forEach((n,i)=> n.classList.toggle('now', i===idx));
  }

  function init(newLat, newLon, force=false){
    if(!force && lat===newLat && lon===newLon && schedule.length) return;
    lat = Number(newLat); lon = Number(newLon);
    elLocEcho.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)} (${tz})`;

    const built = buildSchedule(tzMidnightUTC(tz), lat, lon);
    schedule = built.out;

    lastPlanet=null; lastPct=0; chip.style.left='0%'; chip.textContent='–';

    elSuninfo.textContent =
      `Sunrise ${fmtInTZ(built.sunrise,tz)} • Sunset ${fmtInTZ(built.sunset,tz)} • Next sunrise ${fmtInTZ(built.nextSunrise,tz)} • ${built.weekdayName} ruled by ${DAY_RULER[built.weekday]}`;

    renderList();
    updateNow();
  }

  // Buttons
  geoBtn.onclick = () => {
    if(!navigator.geolocation){ alert("Geolocation not supported."); return; }
    navigator.geolocation.getCurrentPosition(
      pos => { elLat.value=pos.coords.latitude.toFixed(6); elLon.value=pos.coords.longitude.toFixed(6); init(pos.coords.latitude,pos.coords.longitude,true); },
      err => alert("Location error: "+err.message),
      { enableHighAccuracy:true, timeout:10000, maximumAge:60000 }
    );
  };
  setBtn.onclick = () => init(elLat.value, elLon.value, true);
  useTzBtn.onclick = () => {
    const opt = tzSelect.options[tzSelect.selectedIndex];
    tz = tzSelect.value;
    const repLat = parseFloat(opt.dataset.lat), repLon = parseFloat(opt.dataset.lon);
    elLat.value = repLat.toFixed(6); elLon.value = repLon.toFixed(6);
    init(repLat, repLon, true);
  };

  // --------- BOOT WITH DENVER (no clicks required) ----------
  tz = "America/Denver";
  tzSelect.value = "America/Denver";
  elLat.value = "40.760800";            // Salt Lake City-ish default you used
  elLon.value = "-111.891000";
  init(parseFloat(elLat.value), parseFloat(elLon.value), true);

  // ticker
  setInterval(updateNow, 1000);

  // midnight refresh in chosen tz
  (function midnightLoop(){
    const nextMid = new Date(tzMidnightUTC(tz).getTime() + 24*3600*1000 + 50);
    setTimeout(()=>{ init(lat,lon,true); midnightLoop(); }, Math.max(0,nextMid - Date.now()));
  })();
})();
</script>
</body>
</html>
