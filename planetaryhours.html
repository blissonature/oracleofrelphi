<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planetary Hours</title>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<style>
:root{--bg:#fff;--ink:#111;--mut:#666;--line:#e9e9e9;--pill:#f7f7f7;--bar:#eee;--barfill:#111;
--chip:#f2f2f2;--ok:#0a7;--bad:#c00;}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
h1,h2{margin:8px 0 6px}
h1{font-size:40px;display:flex;gap:10px;align-items:center}
h2{font-size:20px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.pill{background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:9px 12px;font-weight:600}
.pill.small{padding:6px 10px;font-weight:500}
.card{border:1px solid var(--line);border-radius:14px;padding:14px;margin:16px 0}
label{font-size:13px;color:#333}
input,select,button{border:1px solid var(--line);border-radius:10px;padding:9px 12px;background:#fff}
button{cursor:pointer}
input[type="time"]{width:120px}
input[type="date"]{width:160px}
.mono{font-variant-numeric:tabular-nums; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
.tiny{font-size:12px;color:var(--mut)}
.hrbar{height:12px;background:var(--bar);border-radius:999px;overflow:hidden;position:relative}
.hrbar>.fill{position:absolute;inset:0;width:0;background:var(--barfill)}
.hrbar .limit{position:absolute;top:0;bottom:0;width:2px;background:#bbb}
.hrbar .sunrise{background:#ffcc00}
.hrbar .sunset{background:#ff8d00}
.hero{position:sticky;top:0;background:linear-gradient(var(--bg),var(--bg));z-index:1;border-bottom:1px solid var(--line);padding:8px 0}
.grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.tbl{width:100%;border-collapse:separate;border-spacing:0}
.tbl th,.tbl td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
.tbl th{position:sticky;top:0;background:#fafafa;z-index:2}
.badge{font-size:12px;border:1px solid var(--line);background:#fafafa;border-radius:999px;padding:2px 8px}
.now{background:#fff6d6}
.sep{height:1px;background:var(--line);margin:14px 0}
.symbol{font-size:40px;line-height:1}
.ok{color:var(--ok)}
.warn{color:var(--bad)}
@media (max-width:760px){ .grid{grid-template-columns:1fr} h1{font-size:32px} }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="row" style="justify-content:space-between;align-items:center">
    <div>
      <div class="tiny mono" id="headMeta">—</div>
      <h1 id="heroTitle"><span class="symbol" id="heroGlyph">☉</span><span id="heroName">Sun</span></h1>
      <div class="row">
        <span class="pill mono" id="curRange">—</span>
        <span class="pill mono" id="curCountdown">Next in —</span>
        <button class="pill small" id="copyLinkBtn">Copy link to this view</button>
      </div>
    </div>
    <div class="pill mono" id="clock">—:—</div>
  </div>

  <!-- Controls -->
  <div class="card">
    <h2>Location &amp; Time</h2>
    <div class="row">
      <button id="geoBtn">Use my location</button>
      <select id="tzSel"></select>
      <label>Lat <input id="lat" size="10" class="mono"/></label>
      <label>Lon <input id="lon" size="11" class="mono"/></label>
      <button id="setLatLon">Set</button>
      <span class="tiny mono" id="latlonEcho">—</span>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="row" style="gap:8px">
        <input type="checkbox" id="useSystem" checked /> Use system date/time
      </label>
      <label>Date <input type="date" id="datePick"/></label>
      <label>Time <input type="time" id="timePick"/></label>
      <button id="useNow">Use now</button>
      <button id="applyDT">Apply</button>
      <span class="tiny">Day runs from sunrise → next sunrise.</span>
    </div>
  </div>

  <!-- Current Hour band -->
  <div class="hero">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row">
        <span class="pill small" id="nextPill">Next: —</span>
      </div>
      <div class="row">
        <!-- hour ruler name & phase live here, tight to ticker -->
        <span class="pill" id="hourRulerPill">—</span>
        <span class="pill small" id="brightDark">—</span>
      </div>
      <div class="row">
        <span class="pill small" id="prevPill">Prev: —</span>
      </div>
    </div>
    <div class="hrbar" style="margin:10px 0 0">
      <div class="limit sunrise" id="sunriseBar" title="Sunrise"></div>
      <div class="limit sunset"  id="sunsetBar"  title="Sunset"></div>
      <div class="fill" id="hrFill"></div>
    </div>
    <div class="tiny mono" id="dayLimits">—</div>
  </div>

  <!-- Day & Hour detail -->
  <div class="grid">
    <div class="card">
      <h2>Day ruler</h2>
      <div class="row">
        <span class="pill" id="dayRulerPill">—</span>
      </div>
      <div id="dayFocus" style="margin-top:6px">—</div>
      <div class="sep"></div>
      <div class="mono tiny" id="sunTimes">—</div>
      <div class="mono tiny" id="bridgeInfo" style="margin-top:6px">—</div>
    </div>
    <div class="card">
      <h2>Multiplier</h2>
      <div style="font-size:40px;font-weight:800" id="multBig">x—</div>
      <div class="tiny">Power = day orbit × hour orbit × (1/ordinal)</div>
      <div class="tiny mono" id="multDetail" style="margin-top:6px">—</div>
      <div class="sep"></div>
      <div class="tiny mono" id="ordinalInfo">—</div>
      <div class="tiny mono" id="hoursRuledInfo" style="margin-top:4px">—</div>
    </div>
    <div class="card">
      <h2>Hour focus</h2>
      <div id="hourFocus">—</div>
    </div>
  </div>

  <!-- Table of 24 hours -->
  <div class="card">
    <h2>Today’s Planetary Hours</h2>
    <table class="tbl mono" id="hoursTable">
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th style="width:160px">Start</th>
          <th style="width:160px">End</th>
          <th style="width:160px">Ruler</th>
          <th>Order</th>
          <th style="width:120px">n/24</th>
          <th style="width:120px">Mult</th>
          <th>Focus</th>
        </tr>
      </thead>
      <tbody id="hoursTBody"></tbody>
    </table>
  </div>

  <!-- Weekly bridge table -->
  <div class="card">
    <h2>Bridge Hours (last dark → first bright)</h2>
    <table class="tbl mono" id="bridgeTbl">
      <thead><tr><th>Day</th><th>Last dark hour</th><th>Mult</th><th>Next day</th><th>First hour</th><th>Mult</th><th>Δ</th></tr></thead>
      <tbody id="bridgeTBody"></tbody>
    </table>
  </div>

</div>

<script>
// ---------- Constants ----------
const WEEKDAY_NAME = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const ORDER = ["Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon"];
const DAY_RULER = {0:"Sun",1:"Moon",2:"Mars",3:"Mercury",4:"Jupiter",5:"Venus",6:"Saturn"};
const GLYPH = {Sun:"☉", Moon:"☽", Mars:"♂", Mercury:"☿", Jupiter:"♃", Venus:"♀", Saturn:"♄"};
const ORBIT_YEARS = { Sun:1, Moon:0.0748, Mercury:0.2408, Venus:0.6152, Mars:1.8808, Jupiter:11.862, Saturn:29.4571 };
const DAY_ESSENCE = {
  Sun:"Leadership, visibility, vitality",
  Moon:"Care, adaptation, memory",
  Mars:"Courage, decisive action",
  Mercury:"Thinking, trade, documents",
  Jupiter:"Growth, teaching, wisdom",
  Venus:"Harmony, art, affection",
  Saturn:"Structure, boundaries, endurance"
};
const HOUR_FOCUS = {
  Sun:{Bright:"Lead, shine, self-expression", Dark:"Restore vitality, inner radiance"},
  Moon:{Bright:"Deep self-care, nurture",     Dark:"Dream incubation, subconscious healing"},
  Mars:{Bright:"Bold action, decisive push",  Dark:"Inner discipline, calm resolve"},
  Mercury:{Bright:"Communication, learning",  Dark:"Drafts, analysis, silent planning"},
  Jupiter:{Bright:"Teaching, wise order",     Dark:"Satisfying rest, quiet faith"},
  Venus:{Bright:"Beauty, art, connection",    Dark:"Night comfort, reconciliation"},
  Saturn:{Bright:"Grounding, stillness, solitude", Dark:"Profound rest, karmic audit"}
};

// ---------- State ----------
const state = {
  lat: 40.7608, lon: -111.8910,
  tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC",
  now: new Date(), manual: null, useSystem:true,
  schedule:[], sunrise:null, sunset:null, nextSunrise:null,
  dayRuler:null, weekdayName:null, ordMap:new Map(), stats:null
};

// ---------- Helpers ----------
const $ = s => document.querySelector(s);
const fmtHM = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
const startOfLocalDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
const clamp01 = x => Math.max(0, Math.min(1, x));

function chaldeanSequence(startPlanet, L){
  const s = ORDER.indexOf(startPlanet);
  return Array.from({length:L}, (_,i)=> ORDER[(s+i)%ORDER.length]);
}

// Anchor planetary day to yesterday if before today’s sunrise
function pickPlanetaryDayAnchor(lat, lon, now=new Date()){
  const today0 = startOfLocalDay(now);
  const tToday = SunCalc.getTimes(today0, lat, lon);
  if (!tToday.sunrise || !tToday.sunset){
    const wd = today0.getDay();
    return {anchor:today0, times:tToday, dayRuler:DAY_RULER[wd], weekdayName:WEEKDAY_NAME[wd]};
  }
  const anchor = (now < tToday.sunrise) ? new Date(today0.getTime()-86400000) : today0;
  const times  = SunCalc.getTimes(anchor, lat, lon);
  const wd = anchor.getDay();
  return {anchor, times, dayRuler:DAY_RULER[wd], weekdayName:WEEKDAY_NAME[wd]};
}

// Build schedule for sunrise→next sunrise of anchor
function buildSchedule(anchor, lat, lon){
  const t = SunCalc.getTimes(anchor, lat, lon);
  const sunrise = t.sunrise, sunset = t.sunset;
  const next0 = new Date(anchor.getFullYear(), anchor.getMonth(), anchor.getDate()+1);
  const tNext = SunCalc.getTimes(next0, lat, lon);
  const nextSunrise = tNext.sunrise;

  const dayLen   = sunset - sunrise;
  const nightLen = nextSunrise - sunset;
  const dayHour  = dayLen / 12;
  const nightHour= nightLen / 12;

  const dayRuler = DAY_RULER[anchor.getDay()];
  const daySeq   = chaldeanSequence(dayRuler, 12);
  const nightSeq = chaldeanSequence(daySeq[12 % 7], 12);

  const list = [];
  for(let i=0;i<12;i++)
    list.push({idx:i+1, start:new Date(sunrise.getTime()+ i*dayHour), end:new Date(sunrise.getTime()+(i+1)*dayHour), planet:daySeq[i], phase:"Bright"});
  for(let i=0;i<12;i++)
    list.push({idx:13+i, start:new Date(sunset.getTime()+ i*nightHour), end:new Date(sunset.getTime()+(i+1)*nightHour), planet:nightSeq[i], phase:"Dark"});

  return {list, sunrise, sunset, nextSunrise, dayRuler};
}

// Ordinals & stats
function ordinalsFor(list){
  const seen = {Saturn:0,Jupiter:0,Mars:0,Sun:0,Venus:0,Mercury:0,Moon:0};
  const map = new Map();
  list.forEach(h=>{
    seen[h.planet]++; 
    const n = seen[h.planet];
    const ord = n===1?"1st":n===2?"2nd":n===3?"3rd":"4th";
    map.set(h, {nth:n, ord});
  });
  return map;
}
function hoursRuledStats(list){
  const acc = {}; ORDER.forEach(p=>acc[p]={Bright:0,Dark:0,Total:0});
  list.forEach(h=>{ acc[h.planet][h.phase]++; acc[h.planet].Total++; });
  return acc;
}

// Multiplier: dayOrbit × hourOrbit × (1/ordinal)
function multiplier(dayPlanet, hourPlanet, ordinalN){
  const day = ORBIT_YEARS[dayPlanet];
  const hr  = ORBIT_YEARS[hourPlanet];
  const ordFactor = 1 / (ordinalN || 1);
  return day * hr * ordFactor;
}

// ---------- Paint ----------
function paintHero(){
  const nowMs = state.now.getTime();
  const idx = state.schedule.findIndex(h => nowMs>=h.start.getTime() && nowMs<h.end.getTime());
  const cur = state.schedule[idx>=0?idx:0];

  // header
  $('#heroGlyph').textContent = GLYPH[cur.planet] || "•";
  $('#heroName').textContent  = cur.planet;
  $('#curRange').textContent  = `${fmtHM(cur.start)} – ${fmtHM(cur.end)}`;

  // prev/next pills (left = next incoming, right = previous)
  const prev = state.schedule[(idx-1+24)%24];
  const next = state.schedule[(idx+1)%24];
  $('#nextPill').textContent = `Next: ${GLYPH[next.planet]||''} ${next.planet}  ${fmtHM(next.start)}`;
  $('#prevPill').textContent = `Prev: ${GLYPH[prev.planet]||''} ${prev.planet}  ${fmtHM(prev.end)}`;

  // ticker
  const dur  = cur.end - cur.start;
  const p    = clamp01((nowMs - cur.start.getTime())/dur);
  $('#hrFill').style.width = `${100*p}%`;

  // sunrise/sunset marks over full planetary day span
  const span = state.nextSunrise - state.sunrise;
  const srx = 0;
  const ssx = clamp01((state.sunset - state.sunrise)/span);
  $('#sunriseBar').style.left = `${100*srx}%`;
  $('#sunsetBar').style.left  = `${100*ssx}%`;
  $('#dayLimits').textContent = `Sunrise ${fmtHM(state.sunrise)} • Sunset ${fmtHM(state.sunset)} • Next sunrise ${fmtHM(state.nextSunrise)}`;

  // countdown
  const remain = cur.end.getTime()-nowMs;
  const mins = Math.floor(remain/60000);
  const secs = Math.floor((remain%60000)/1000);
  $('#curCountdown').textContent = `Next in ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;

  // hour ruler (tight under ticker)
  $('#hourRulerPill').textContent = `${GLYPH[cur.planet]||''} ${cur.planet}`;
  $('#brightDark').textContent = cur.phase;

  // day ruler & focus (anchored)
  $('#dayRulerPill').textContent = `${GLYPH[state.dayRuler]||''} ${state.dayRuler}`;
  $('#dayFocus').textContent = DAY_ESSENCE[state.dayRuler] || '—';
  $('#sunTimes').textContent = `Sunrise ${fmtHM(state.sunrise)} • Sunset ${fmtHM(state.sunset)} • Next sunrise ${fmtHM(state.nextSunrise)}`;

  // multiplier & ordinals
  const ord = state.ordMap.get(cur) || {nth:1, ord:"1st"};
  const mult = multiplier(state.dayRuler, cur.planet, ord.nth);
  $('#multBig').textContent = `x${mult.toFixed(3)}`;
  $('#multDetail').textContent = `${state.dayRuler}(${ORBIT_YEARS[state.dayRuler]}) × ${cur.planet}(${ORBIT_YEARS[cur.planet]}) × 1/${ord.nth}`;
  $('#ordinalInfo').textContent = `Order today: ${ord.ord} of ${Math.min(4,state.stats[cur.planet].Total)} • Hour ${cur.idx}/24`;

  const st = state.stats[cur.planet];
  $('#hoursRuledInfo').textContent = `Hours ruled by ${cur.planet} today — Bright:${st.Bright} • Dark:${st.Dark} • Total:${st.Total}`;

  // hour focus
  $('#hourFocus').textContent = HOUR_FOCUS[cur.planet]?.[cur.phase] || '—';
}
function paintTable(){
  const tbody = $('#hoursTBody'); tbody.innerHTML = '';
  const nowMs = state.now.getTime();
  state.schedule.forEach(h=>{
    const ord = state.ordMap.get(h);
    const mult = multiplier(state.dayRuler, h.planet, ord.nth);
    const tr = document.createElement('tr');
    if (nowMs>=h.start.getTime() && nowMs<h.end.getTime()) tr.classList.add('now');
    tr.innerHTML = `
      <td>${h.idx} <span class="badge">${h.phase}</span></td>
      <td>${fmtHM(h.start)}</td>
      <td>${fmtHM(h.end)}</td>
      <td>${GLYPH[h.planet]||''} ${h.planet}</td>
      <td>${ord.ord} (Octave)</td>
      <td>${h.idx}/24</td>
      <td>x${mult.toFixed(3)}</td>
      <td>${HOUR_FOCUS[h.planet]?.[h.phase] || ''}</td>`;
    tbody.appendChild(tr);
  });
}
function paintWeeklyBridges(){
  const days = ["Saturn","Sun","Moon","Mars","Mercury","Jupiter","Venus"];
  const tbody = $('#bridgeTBody'); tbody.innerHTML = '';
  for(let i=0;i<days.length;i++){
    const day = days[i], next = days[(i+1)%days.length];
    const lastDarkRuler = chaldeanSequence(day, 24)[23];
    const firstBrightRuler = chaldeanSequence(next,1)[0];
    const m1 = ORBIT_YEARS[day]*ORBIT_YEARS[lastDarkRuler]*(1/4);
    const m2 = ORBIT_YEARS[next]*ORBIT_YEARS[firstBrightRuler]*(1/1);
    const delta = m2 - m1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${day}</td>
      <td>${lastDarkRuler}</td>
      <td>x${m1.toFixed(3)}</td>
      <td>${next}</td>
      <td>${firstBrightRuler}</td>
      <td>x${m2.toFixed(3)}</td>
      <td class="${delta>=0?'ok':'warn'}">${delta>=0?'+':''}${delta.toFixed(3)}</td>`;
    tbody.appendChild(tr);
  }
}

// ---------- Rebuild ----------
function getNow(){
  if (state.useSystem || !state.manual) return new Date();
  return new Date(state.manual.getTime());
}
function rebuild(forcedNow=null){
  if (forcedNow) state.manual = new Date(forcedNow);
  state.now = getNow();

  const {anchor, dayRuler, weekdayName} = pickPlanetaryDayAnchor(state.lat, state.lon, state.now);
  const built = buildSchedule(anchor, state.lat, state.lon);

  state.schedule = built.list;
  state.sunrise = built.sunrise;
  state.sunset = built.sunset;
  state.nextSunrise = built.nextSunrise;
  state.dayRuler = dayRuler;           // anchored (yesterday if pre-sunrise)
  state.weekdayName = weekdayName;     // anchored label (not displayed as a pill)

  state.ordMap = ordinalsFor(state.schedule);
  state.stats  = hoursRuledStats(state.schedule);

  paintHero();
  paintTable();
  paintWeeklyBridges();
}

// ---------- Controls ----------
function fillTZSelect(){
  const tz = (Intl.supportedValuesOf?.("timeZone")) || [state.tz,"UTC"];
  $('#tzSel').innerHTML = tz.map(z=>`<option ${z===state.tz?'selected':''}>${z}</option>`).join('');
}
function setLatLonEcho(){
  $('#latlonEcho').textContent = `${(+state.lat).toFixed(4)}, ${(+state.lon).toFixed(4)}  (${state.tz})`;
}
function initTZ(){
  fillTZSelect();
  $('#tzSel').addEventListener('change', e=>{
    state.tz = e.target.value;
    // (Display-only; SunCalc uses local system tz. For accuracy, keep system tz aligned to location.)
    setLatLonEcho();
  });
}
function initGeo(){
  $('#geoBtn').onclick = ()=>{
    if(!navigator.geolocation){ alert("Geolocation not supported."); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      state.lat = +pos.coords.latitude;
      state.lon = +pos.coords.longitude;
      $('#lat').value = state.lat.toFixed(6);
      $('#lon').value = state.lon.toFixed(6);
      setLatLonEcho();
      rebuild();
    }, err=> alert("Location error: " + err.message));
  };
  $('#setLatLon').onclick = ()=>{
    state.lat = +($('#lat').value||state.lat);
    state.lon = +($('#lon').value||state.lon);
    setLatLonEcho();
    rebuild();
  };
}
function initDateTime(){
  $('#useSystem').addEventListener('change', e=>{
    state.useSystem = e.target.checked;
    if (state.useSystem) state.manual = null;
    rebuild();
  });
  $('#useNow').onclick = ()=>{ state.useSystem=true; $('#useSystem').checked=true; rebuild(); };
  $('#applyDT').onclick = ()=>{
    const d = $('#datePick').value;
    const t = $('#timePick').value || "00:00";
    if (!d){ alert("Pick a date."); return; }
    const [H,M] = t.split(':').map(Number);
    const [Y,Mo,Da] = d.split('-').map(Number);
    const manual = new Date(Y, Mo-1, Da, H, M);
    state.manual = manual; state.useSystem=false; $('#useSystem').checked=false;
    rebuild();
  };
}
function initDeepLink(){
  $('#copyLinkBtn').onclick = ()=>{
    const u = new URL(location.href);
    u.searchParams.set('lat', state.lat.toFixed(6));
    u.searchParams.set('lon', state.lon.toFixed(6));
    u.searchParams.set('tz', state.tz);
    if (!state.useSystem && state.manual){
      u.searchParams.set('dt', state.manual.toISOString());
    } else {
      u.searchParams.delete('dt');
    }
    navigator.clipboard.writeText(u.toString()).then(()=> {
      $('#copyLinkBtn').textContent = "Copied!";
      setTimeout(()=> $('#copyLinkBtn').textContent = "Copy link to this view", 900);
    });
  };
}
function readDeepLink(){
  const q = new URLSearchParams(location.search);
  if (q.has('lat')) state.lat = +q.get('lat');
  if (q.has('lon')) state.lon = +q.get('lon');
  if (q.has('tz'))  state.tz  = q.get('tz');
  if (q.has('dt')){ state.manual = new Date(q.get('dt')); state.useSystem=false; $('#useSystem').checked=false; }
}

// ---------- Clock / Ticker ----------
function tick(){
  state.now = getNow();
  $('#clock').textContent = state.now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  paintHero();
  requestAnimationFrame(tick);
}

// ---------- Boot ----------
(function boot(){
  readDeepLink();
  $('#lat').value = state.lat.toFixed(6);
  $('#lon').value = state.lon.toFixed(6);
  $('#headMeta').textContent = `${new Date().toLocaleDateString([], {month:'short', day:'numeric', year:'numeric'})} • ${state.tz}`;
  initTZ(); initGeo(); initDateTime(); initDeepLink(); setLatLonEcho();
  rebuild();
  tick();
})();
</script>
</body>
</html>
