<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planetary Hours</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#11151a; --muted:#96a1b0; --text:#e9eef5; --ring:#263244;
      --chip:#1a2028; --accent:#7aa2ff; --ok:#59d69e; --warn:#ffd166; --bad:#ef6b73;
      --saturn:#c0b28a; --sun:#ffb100; --moon:#c9d6ff; --mars:#ff6b6b; --mercury:#8bd3ff; --jupiter:#9dde7a; --venus:#ff9ad1;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(11,13,16,.95),rgba(11,13,16,.75));backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--ring)}
    header .row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 0}
    .title{font-size:24px;font-weight:700}
    .clock{font-variant-numeric:tabular-nums;border:1px solid var(--ring);padding:6px 10px;border-radius:10px;background:var(--chip)}
    .btn{background:#1d2430;border:1px solid var(--ring);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--ring);background:var(--chip);font-weight:600}
    .tiny{font-size:12px;color:var(--muted)}
    .section{border:1px solid var(--ring);border-radius:14px;padding:12px;margin-top:14px;background:var(--panel)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .row > *{margin-right:6px}
    .grow{flex:1}
    select, input[type="text"], input[type="number"], input[type="time"], input[type="date"]{background:#0f141b;color:var(--text);border:1px solid var(--ring);border-radius:10px;padding:8px}
    label.switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    label.switch input{appearance:none;width:38px;height:22px;border-radius:999px;background:#111a24;border:1px solid var(--ring);position:relative;outline:none}
    label.switch input:checked{background:#17314f}
    label.switch input::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:999px;background:#dbe3f1;transition:left .2s}
    label.switch input:checked::after{left:19px}

    .hero{display:grid;grid-template-columns:1fr;gap:12px}
    .ticker{position:relative;border:1px solid var(--ring);border-radius:12px;height:18px;background:#0e141b;overflow:hidden}
    .bar{position:absolute;top:0;bottom:0;width:2px;background:var(--ok)}
    .day-start,.day-end{position:absolute;top:0;bottom:0;width:2px;background:var(--accent)}
    .sunrise,.sunset{position:absolute;top:0;bottom:0;width:2px;background:var(--warn)}
    .ticker-labels{display:flex;justify-content:space-between;font-variant-numeric:tabular-nums}
    .hero-core{display:grid;gap:10px;justify-items:center;text-align:center}
    .mult{font-size:38px;font-weight:800;letter-spacing:.5px}
    .ord{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#0e1319;border-bottom:1px solid var(--ring);z-index:5}
    th,td{padding:8px;border-bottom:1px solid var(--ring);vertical-align:top}
    tr.active{background:rgba(122,162,255,.08)}
    .bdg{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid var(--ring);font-size:12px}
    .bdg.bright{background:rgba(255,177,0,.1);border-color:#614d1a}
    .bdg.dark{background:rgba(96,115,148,.2)}

    .matrix{overflow:auto}
    .matrix table td{min-width:160px}

    details{border:1px dashed var(--ring);border-radius:12px;padding:10px}

    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .p-saturn{color:var(--saturn)} .p-sun{color:var(--sun)} .p-moon{color:var(--moon)} .p-mars{color:var(--mars)} .p-mercury{color:var(--mercury)} .p-jupiter{color:var(--jupiter)} .p-venus{color:var(--venus)}
    .d-saturn{background:var(--saturn)} .d-sun{background:var(--sun)} .d-moon{background:var(--moon)} .d-mars{background:var(--mars)} .d-mercury{background:var(--mercury)} .d-jupiter{background:var(--jupiter)} .d-venus{background:var(--venus)}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}
  </style>
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="title">Planetary Hours</div>
        <div class="row">
          <div class="clock" id="localClock">--:--</div>
          <button class="btn" id="copyLink">Copy link to this view</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="section" id="controls">
      <div class="row" style="gap:14px">
        <button class="btn" id="useGeo">Use my location</button>
        <label>Timezone
          <select id="tzSelect"></select>
        </label>
        <label>Lat <input type="number" id="lat" step="0.0001" style="width:120px"></label>
        <label>Lon <input type="number" id="lon" step="0.0001" style="width:120px"></label>
        <button class="btn" id="setLatLon">Set</button>
        <div class="tiny" id="echo">—</div>
      </div>
      <div class="row" style="gap:14px;margin-top:10px">
        <label class="switch">Use system date/time <input type="checkbox" id="useSystem" checked></label>
        <div id="manualTime" style="display:none" class="row">
          <label>Date <input type="date" id="datePick"></label>
          <label>Time <input type="time" id="timePick"></label>
          <button class="btn" id="applyDT">Apply</button>
        </div>
        <div class="tiny">Day runs sunrise→sunrise.</div>
      </div>
      <div class="row" style="gap:14px;margin-top:10px">
        <label>Weights:
          <select id="mode">
            <option value="sidereal">Sidereal (default)</option>
            <option value="ratio">Current Hour / Total Hours today (this ruler)</option>
            <option value="hybrid">Hybrid (sidereal×synodic)</option>
          </select>
        </label>
      </div>
    </section>

    <section class="section" id="daySummary">
      <div class="grid-2">
        <div>
          <div id="dayRuler" class="pill"></div>
          <div class="tiny" id="dayRulerMeta"></div>
        </div>
        <div>
          <div>Sun times:</div>
          <div id="sunTimes" class="tiny"></div>
          <div id="bridgeInfo" class="tiny" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <section class="section hero" id="hero">
      <div class="ticker" id="ticker">
        <div class="day-start" id="dayStart"></div>
        <div class="sunrise" id="sunriseBar"></div>
        <div class="sunset" id="sunsetBar"></div>
        <div class="day-end" id="dayEnd"></div>
        <div class="bar" id="progress"></div>
      </div>
      <div class="ticker-labels tiny"><span id="lblStart">--:--</span><span id="lblEnd">--:--</span></div>

      <div class="hero-core">
        <div id="currentHourPill" class="pill">—</div>
        <div class="mult" id="mult">x—</div>
        <div class="ord" id="ordLine">Power = (day×hour)×(1/ord) + ord</div>
        <div class="tiny" id="hourMeta"></div>
        <div class="chips" id="legendChips"></div>
      </div>
    </section>

    <section class="section" id="tableSection">
      <div style="overflow:auto; max-height:460px">
        <table id="hoursTable">
          <thead>
            <tr>
              <th>#</th><th>Start–End</th><th>Ruler</th><th>Order</th><th>Hour n/24</th><th>Hours ruled (B/D/T)</th><th>Multiplier</th><th>Focus</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="section" id="matrixSection">
      <div class="row" style="justify-content:space-between"><div>7×7 Focus Matrix</div>
        <label>Filter: 
          <select id="matrixFilter"><option value="all">All</option><option value="bright">Bright</option><option value="dark">Dark</option></select>
        </label>
      </div>
      <div class="matrix" style="margin-top:8px">
        <table id="matrixTable"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="section" id="bridgePanel">
      <div>Weekly Bridge Hours (last dark → first bright)</div>
      <div style="overflow:auto">
        <table id="bridgeTable">
          <thead><tr><th>Day (last hour)</th><th>Multiplier</th><th>Next day (first hour)</th><th>Multiplier</th><th>Δ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <details>
        <summary>About / Help</summary>
        <p><b>Multipliers.</b> Default “Sidereal” mode uses the orbital periods (Earth years) as weights: Saturn 29.46, Jupiter 11.86, Mars 1.88, Sun 1, Venus 0.615, Mercury 0.241, Moon 0.0748. Power for an hour = (DayWeight × HourWeight) × (1/ordinal) + ordinal. “Ratio” mode scales by how many hours this ruler holds today (bright+dark), and “Hybrid” multiplies Sidereal × (synodic-hour fraction).</p>
        <p><b>Sunrise→Sunrise frame.</b> The “day” begins at local sunrise and ends at the next sunrise.</p>
        <p><b>Ordinals & Harmonics.</b> 1st Fundamental, 2nd Octave, 3rd Fifth, 4th Double Octave. Higher ordinals continue similarly; lower ordinals amplify power in the formula via 1/ordinal.</p>
        <p><b>Legend.</b> Bright = post‑sunrise half; Dark = post‑sunset half. Bridge hour is the final hour before sunrise of the next day; its ruler hands the baton to Hour 1.</p>
        <p><b>Modes.</b> Sidereal / Ratio / Hybrid as above.</p>
      </details>
    </section>
  </main>

  <script>
  const planets = [
    {key:'saturn',  sym:'♄', name:'Saturn',  color:'var(--saturn)', weight:29.46, focusDay:'Structure, boundaries, karmic audit', focusHour:'Consolidate, prune, commit'},
    {key:'jupiter', sym:'♃', name:'Jupiter', color:'var(--jupiter)',weight:11.86, focusDay:'Growth, teaching, wisdom',       focusHour:'Expand, publish, mentor'},
    {key:'mars',    sym:'♂', name:'Mars',    color:'var(--mars)',   weight:1.88,  focusDay:'Courage, cutting, heat',        focusHour:'Act, compete, cauterize'},
    {key:'sun',     sym:'☉', name:'Sun',     color:'var(--sun)',    weight:1.00,  focusDay:'Vitality, authority, radiance', focusHour:'Lead, clarify, spotlight'},
    {key:'venus',   sym:'♀', name:'Venus',   color:'var(--venus)',  weight:0.615, focusDay:'Harmony, bonds, aesthetics',     focusHour:'Relate, attract, refine'},
    {key:'mercury', sym:'☿', name:'Mercury', color:'var(--mercury)',weight:0.241, focusDay:'Trade, signals, analysis',      focusHour:'Write, ship, negotiate'},
    {key:'moon',    sym:'☽', name:'Moon',    color:'var(--moon)',   weight:0.0748,focusDay:'Care, tides, memory',           focusHour:'Nourish, adapt, reflect'},
  ];
  const byKey = Object.fromEntries(planets.map(p=>[p.key,p]));
  const chaldean = ['saturn','jupiter','mars','sun','venus','mercury','moon'];
  function rotateTo(dayKey){ const idx=chaldean.indexOf(dayKey); const seq=[]; for(let i=0;i<24;i++) seq.push(chaldean[(idx+i)%7]); return seq; }
  function pad(n){return String(n).padStart(2,'0')} 
  function fmtHM(d){return pad(d.getHours()%12||12)+":"+pad(d.getMinutes())+" "+(d.getHours()<12?"AM":"PM")}
  function fmtHM24(d){return pad(d.getHours())+":"+pad(d.getMinutes())}
  function ordinalName(n){ const s=(n%10==1&&n%100!=11)?'st':(n%10==2&&n%100!=12)?'nd':(n%10==3&&n%100!=13)?'rd':'th'; const harmonic=['—','Fundamental','Octave','Fifth','Double Octave'][n]||`${n}th`; return {label:`${n}${s}`,harmonic}; }

  const state = { tz: Intl.DateTimeFormat().resolvedOptions().timeZone, lat: 40.7608, lon: -111.8910, useSystem: true, now: new Date(), mode: 'sidereal' };

  (function readHash(){ try{ const h=new URLSearchParams(location.hash.slice(1)); if(h.get('lat')) state.lat=parseFloat(h.get('lat')); if(h.get('lon')) state.lon=parseFloat(h.get('lon')); if(h.get('tz')) state.tz=h.get('tz'); if(h.get('mode')) state.mode=h.get('mode'); if(h.get('dt')){ state.useSystem=false; state.now=new Date(h.get('dt')); } }catch(e){} })();

  const el = {
    clock: document.getElementById('localClock'), copy: document.getElementById('copyLink'), useGeo: document.getElementById('useGeo'), tzSelect: document.getElementById('tzSelect'), lat: document.getElementById('lat'), lon: document.getElementById('lon'), setLatLon: document.getElementById('setLatLon'), echo: document.getElementById('echo'), useSystem: document.getElementById('useSystem'), manualTime: document.getElementById('manualTime'), datePick: document.getElementById('datePick'), timePick: document.getElementById('timePick'), applyDT: document.getElementById('applyDT'), mode: document.getElementById('mode'), dayRuler: document.getElementById('dayRuler'), dayRulerMeta: document.getElementById('dayRulerMeta'), sunTimes: document.getElementById('sunTimes'), bridgeInfo: document.getElementById('bridgeInfo'), ticker: document.getElementById('ticker'), progress: document.getElementById('progress'), dayStart: document.getElementById('dayStart'), dayEnd: document.getElementById('dayEnd'), sunriseBar: document.getElementById('sunriseBar'), sunsetBar: document.getElementById('sunsetBar'), lblStart: document.getElementById('lblStart'), lblEnd: document.getElementById('lblEnd'), currentHourPill: document.getElementById('currentHourPill'), mult: document.getElementById('mult'), ordLine: document.getElementById('ordLine'), hourMeta: document.getElementById('hourMeta'), legendChips: document.getElementById('legendChips'), hoursTable: document.querySelector('#hoursTable tbody'), matrixTable: document.getElementById('matrixTable'), matrixHead: document.querySelector('#matrixTable thead'), matrixBody: document.querySelector('#matrixTable tbody'), matrixFilter: document.getElementById('matrixFilter'), bridgeTable: document.querySelector('#bridgeTable tbody'), };

  function populateTimezones(){
    const sel=el.tzSelect; sel.innerHTML='';
    const zones=(Intl.supportedValuesOf? Intl.supportedValuesOf('timeZone'):[]).slice();
    for(let o=-12;o<=14;o++){ zones.push(`UTC${o>=0?'+':''}${o}`) }
    zones.sort(); zones.forEach(z=>{ const opt=document.createElement('option'); opt.value=z; opt.textContent=z; sel.appendChild(opt); });
    sel.value = state.tz;
  }

  function tickLocalClock(){ const d=new Date(); el.clock.textContent = pad(d.getHours())+":"+pad(d.getMinutes()); }
  setInterval(tickLocalClock, 1000*15); tickLocalClock();

  el.useGeo.onclick=()=>{ if(!navigator.geolocation){ alert('Geolocation not supported.'); return; } navigator.geolocation.getCurrentPosition(pos=>{ state.lat=pos.coords.latitude; state.lon=pos.coords.longitude; el.lat.value=state.lat.toFixed(4); el.lon.value=state.lon.toFixed(4); smallEcho(); rebuild(); }, _=>{ smallEcho('Geolocation failed — falling back to timezone center.'); }); };

  function smallEcho(extra){ el.echo.textContent = `${state.lat.toFixed(4)}, ${state.lon.toFixed(4)} (${state.tz})` + (extra?` — ${extra}`:''); }
  el.setLatLon.onclick=()=>{ state.lat=parseFloat(el.lat.value); state.lon=parseFloat(el.lon.value); rebuild(); };
  el.tzSelect.onchange=()=>{ state.tz=el.tzSelect.value; rebuild(); };
  el.useSystem.onchange=()=>{ state.useSystem=el.useSystem.checked; el.manualTime.style.display = state.useSystem? 'none':'inline-flex'; if(state.useSystem) rebuild(); };
  el.applyDT.onclick=()=>{ const d=el.datePick.value; const t=el.timePick.value; if(d&&t){ state.now=new Date(`${d}T${t}:00`); rebuild(); } };
  el.mode.onchange=()=>{ state.mode=el.mode.value; rebuild(); };
  el.copy.onclick=()=>{ const url=new URL(location.href); const params=new URLSearchParams(); params.set('lat',state.lat.toFixed(4)); params.set('lon',state.lon.toFixed(4)); params.set('tz',state.tz); params.set('mode',state.mode); if(!state.useSystem){ params.set('dt', toTZISO(state.now,state.tz)); } url.hash=params.toString(); navigator.clipboard.writeText(url.toString()); };

  function toTZISO(date,tz){ const fmt=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); const parts=Object.fromEntries(fmt.formatToParts(date).map(p=>[p.type,p.value])); return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}`; }

  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function computeDayFrame(now,lat,lon,tz){
    const local=new Date(new Date(now).toLocaleString('en-US',{timeZone:tz}));
    const base=new Date(local); base.setHours(12,0,0,0);
    const tt=SunCalc.getTimes(base,lat,lon); const sr=tt.sunrise, ss=tt.sunset;
    if(local>=sr){ const next=SunCalc.getTimes(addDays(base,1),lat,lon); return {start:sr, sunrise:sr, sunset:ss, end:next.sunrise, localNow:local}; }
    const prev=SunCalc.getTimes(addDays(base,-1),lat,lon); return {start:prev.sunrise, sunrise:prev.sunrise, sunset:prev.sunset, end:sr, localNow:local};
  }
  function seqForDay(dayKey){ return rotateTo(dayKey); }
  function dayRulerKeyForWeekday(localStart){ const map={0:'sun',1:'moon',2:'mars',3:'mercury',4:'jupiter',5:'venus',6:'saturn'}; return map[ localStart.getDay() ]; }

  function buildHours(frame, dayKey){
    const seq=seqForDay(dayKey);
    const daylight = frame.sunset - frame.sunrise;
    const night    = frame.end    - frame.sunset;
    const brightLen= daylight/12, darkLen = night/12;
    const rows=[]; let t = frame.start.getTime();
    for(let i=0;i<24;i++){
      const isBright = i<12; const len=isBright?brightLen:darkLen; const start=new Date(t); const end=new Date(t+len);
      const ruler = byKey[ seq[i] ]; rows.push({index:i+1,start,end,ruler,isBright,ordinal:i+1}); t+=len;
    }
    return rows;
  }
  function hoursHeldToday(rows,key){ let b=0,d=0; for(const r of rows){ if(r.ruler.key===key){ r.isBright? b++ : d++; } } return {b,d,t:b+d}; }
  function hourMultiplier(row, dayKey, rows){ const dayW=byKey[dayKey].weight; const hrW=row.ruler.weight; const ord=row.ordinal; const sid=(dayW*hrW)*(1/ord)+ord; const held=hoursHeldToday(rows,row.ruler.key); const ratio=held.t? (held.t/24):0.0001; const hy=sid*ratio; const m=state.mode; const val=m==='sidereal'?sid: m==='ratio'? ratio*10: hy; return {val,sidereal:sid,ratio,hybrid:hy}; }
  function currentIndex(rows, local){
    // Robust index finder using numeric times + binary search to avoid boundary/floating issues
    const t = local.getTime();
    const firstStart = rows[0].start.getTime();
    const lastEnd    = rows[rows.length-1].end.getTime();
    if (t < firstStart) return 0; // before the day frame
    if (t >= lastEnd)  return rows.length-1; // after the frame (shouldn't happen normally)
    let lo = 0, hi = rows.length - 1;
    while (lo <= hi){
      const mid = (lo + hi) >> 1;
      const s = rows[mid].start.getTime();
      const e = rows[mid].end.getTime();
      if (t < s) hi = mid - 1;
      else if (t >= e) lo = mid + 1;
      else return mid; // s <= t < e
    }
    // Fallback clamp
    return Math.max(0, Math.min(rows.length-1, lo));
  }

    // Hero
    const cur=rows[idx];
    el.currentHourPill.innerHTML = `<span class="dot d-${cur.ruler.key}"></span>${cur.ruler.sym} ${cur.ruler.name}`;
    const mult=hourMultiplier(cur,dayKey,rows); el.mult.textContent=`x${mult.val.toFixed(3)}`;
    const ord=ordinalName(cur.ordinal); el.ordLine.textContent=`Power = (day × hour) × (1/ordinal) + ordinal  •  ${ord.label} (${ord.harmonic||'—'})`;
    const held=hoursHeldToday(rows,cur.ruler.key);
    el.hourMeta.textContent=`Hour ${cur.ordinal}/24 • ${cur.isBright?'Bright':'Dark'} • Ruler appearance: ${rows.slice(0,idx+1).filter(r=>r.ruler.key===cur.ruler.key).length} of ${held.t} today • Hours ruled: ${held.b}/${held.d}/${held.t}`;

    el.legendChips.innerHTML='';
    const chip=(p,txt)=>`<span class="pill" style="border-color:${p.color}"><span class=\"dot d-${p.key}\"></span>${p.sym} ${txt}</span>`;
    el.legendChips.insertAdjacentHTML('beforeend', chip(day, `Day: ${day.focusDay.split(',')[0]}`));
    el.legendChips.insertAdjacentHTML('beforeend', chip(cur.ruler, `Hour: ${cur.ruler.focusHour}`));

    const rect=el.ticker.getBoundingClientRect(); const xOf=t=>{ const span=frame.end-frame.start; return ((t-frame.start)/span)*rect.width; };
    el.dayStart.style.left='0px'; el.dayEnd.style.left=(rect.width-2)+'px';
    el.sunriseBar.style.left=xOf(frame.sunrise)+'px'; el.sunsetBar.style.left=xOf(frame.sunset)+'px';
    el.lblStart.textContent=fmtHM(frame.start); el.lblEnd.textContent=fmtHM(frame.end);

    function anim(){ const nowLocal = state.useSystem? new Date(new Date().toLocaleString('en-US',{timeZone:state.tz})) : frame.localNow; const x=xOf(nowLocal); el.progress.style.left=Math.max(0,Math.min(rect.width-2,x))+'px'; requestAnimationFrame(anim); }
    requestAnimationFrame(anim);

    el.hoursTable.innerHTML=''; rows.forEach((r,i)=>{ const multR=hourMultiplier(r,dayKey,rows); const ordR=ordinalName(r.ordinal); const tr=document.createElement('tr'); if(i===idx) tr.classList.add('active'); tr.innerHTML=`
      <td>${r.index} <span class="bdg ${r.isBright?'bright':'dark'}">${r.isBright?'Bright':'Dark'}</span></td>
      <td>${fmtHM(r.start)}–${fmtHM(r.end)}</td>
      <td><span class="dot d-${r.ruler.key}"></span>${r.ruler.sym} ${r.ruler.name}</td>
      <td>${ordR.label} (${ordR.harmonic})</td>
      <td>${r.index}/24</td>
      <td>${hoursHeldToday(rows,r.ruler.key).b}/${hoursHeldToday(rows,r.ruler.key).d}/${hoursHeldToday(rows,r.ruler.key).t}</td>
      <td>x${multR.val.toFixed(3)}</td>
      <td>${contextFocus(day,r.ruler)}</td>`; el.hoursTable.appendChild(tr); });

    buildMatrix();
    buildBridges(frame);

    const params=new URLSearchParams(); params.set('lat',state.lat.toFixed(4)); params.set('lon',state.lon.toFixed(4)); params.set('tz',state.tz); params.set('mode',state.mode); if(!state.useSystem) params.set('dt', toTZISO(state.now,state.tz)); history.replaceState(null,'','#'+params.toString());
  

  function init(){ populateTimezones(); el.lat.value=state.lat.toFixed(4); el.lon.value=state.lon.toFixed(4); el.tzSelect.value=state.tz; el.mode.value=state.mode; smallEcho(); rebuild(); }
  window.addEventListener('resize', rebuild);
  init();
  </script>
</body>
</html>
