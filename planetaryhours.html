<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planetary Hours</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fff; --ink:#111; --sub:#555; --muted:#8a8a8a; --line:#e8e8e8; --chip:#f6f6f6;
    --bar:#eee; --fill:#111;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); background:var(--bg) }
  .wrap{ max-width:1180px; margin:24px auto 100px; padding:0 16px }

  h1,h2,h3{ margin:0 0 10px }
  .muted{ color:var(--muted) }
  .sub{ color:var(--sub); font-size:.95rem }
  .mono{ font-variant-numeric:tabular-nums; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }

  .section{ border:1px solid var(--line); border-radius:14px; padding:16px; margin:16px 0; background:#fff }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  .pill{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--line); background:#fff; border-radius:999px; padding:.5rem .9rem; }
  .pill.tiny{ padding:.3rem .6rem; font-size:.9rem; background:var(--chip); }
  label{ font-size:.85rem; color:#444 }
  input,select,button{ padding:.5rem .6rem; border:1px solid var(--line); border-radius:8px; background:#fff }
  button{ cursor:pointer }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
  .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px }
  @media (max-width:900px){ .grid2,.grid3{ grid-template-columns:1fr } }

  /* Hero */
  .hero h1{ font-size:58px; line-height:1; display:flex; gap:.6rem; align-items:center }
  .tickerRow{ display:flex; align-items:center; gap:12px; margin:2px 0 8px }
  .tickerBar{ flex:1 }
  .bar{ height:10px; background:var(--bar); border-radius:999px; overflow:hidden }
  .bar > div{ height:100%; width:0%; background:var(--fill) }
  .chipsUnderTitle{ gap:10px; margin:6px 0 8px }
  .divider{ height:1px; background:var(--line); margin:12px 0 }
  .edgeRow{ display:flex; gap:12px; justify-content:flex-end; margin:6px 0 8px }

  /* Hours grid */
  .hrs{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
  @media (max-width:1020px){ .hrs{ grid-template-columns:1fr 1fr } }
  @media (max-width:640px){ .hrs{ grid-template-columns:1fr } }
  .hr{ border:1px solid var(--line); border-radius:12px; padding:10px }
  .hr.now{ border-color:#999; box-shadow:0 0 0 2px #00000010 inset }
  .hr .t{ font-weight:600 }

  /* 7x7 matrix */
  .matrix{ overflow:auto }
  table{ width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--line); border-radius:12px; overflow:hidden }
  th,td{ padding:10px 12px; border-bottom:1px solid var(--line); vertical-align:top }
  th{ background:#fafafa; text-align:left; font-weight:600 }
  tr:last-child td{ border-bottom:none }

  .note{ font-size:.9rem; color:var(--sub) }

  .k{ display:inline-flex; gap:.35rem; align-items:center }
  .sym{ font-size:1.05em }
</style>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="row" style="justify-content:space-between; margin-bottom:10px">
    <div>
      <div class="muted">Planetary Hours</div>
      <div class="mono" id="headClock">—</div>
      <div class="muted mono" id="locEchoTop">—</div>
    </div>
    <button id="copyLink">Copy link to this view</button>
  </div>

  <!-- Location & Time -->
  <div class="section">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="geoBtn">Use my location</button>
        <select id="tzSel">
          <option value="auto">Auto (system)</option>
          <option value="UTC">UTC (0°)</option>
        </select>
        <label>Lat <input id="lat" size="8" placeholder="40.76"></label>
        <label>Lon <input id="lon" size="8" placeholder="-111.89"></label>
        <button id="setBtn">Set</button>
      </div>
      <div class="row">
        <label>Date <input type="date" id="datePick"></label>
        <label>Time <input type="time" id="timePick"></label>
        <button id="useNow">Use now</button>
        <button id="applyDT">Apply</button>
      </div>
    </div>
    <div class="muted mono" id="locEcho">—</div>
    <div class="note" style="margin-top:6px">Day runs from sunrise → next sunrise.</div>
  </div>

  <!-- Edge pills above hero -->
  <div class="edgeRow">
    <div id="prevPill" class="pill tiny mono">—</div>
    <div id="nextPill" class="pill tiny mono">—</div>
  </div>

  <!-- Hero band -->
  <div class="section hero">
    <div class="tickerRow">
      <div class="tickerBar"><div class="bar"><div id="tickfill"></div></div></div>
    </div>

    <h1>
      <span id="titleSymbol">☉</span>
      <span id="titleName">Sun</span>
    </h1>

    <div class="row chipsUnderTitle">
      <span class="pill mono" id="currentRange">—</span>
      <span class="pill mono" id="countdown">—</span>
    </div>

    <div class="divider"></div>

    <div class="grid3">
      <div>
        <div class="muted">Day ruler</div>
        <div class="row" style="align-items:center;gap:10px">
          <span class="pill" id="dayRulerPill">☉ Sun</span>
        </div>
        <div id="dayFocus" class="sub" style="margin-top:6px">—</div>
        <div class="note mono" id="sunline" style="margin-top:8px">—</div>
      </div>

      <div>
        <div class="muted">Hour ruler</div>
        <div class="row" style="align-items:center;gap:10px">
          <span class="pill" id="hourRulerPill">☉ Sun</span>
          <span class="pill tiny" id="phaseBadge">Bright</span>
        </div>
        <div id="hourFocus" class="sub" style="margin-top:6px">—</div>
      </div>

      <div>
        <div class="muted">Multiplier</div>
        <div id="multBig" style="font-size:36px;font-weight:800">x1.000</div>
        <div class="sub">Power = day orbit × hour orbit</div>
      </div>
    </div>
  </div>

  <!-- Day summary / bridge -->
  <div class="section">
    <h3 style="margin-bottom:6px">Bridge hour (last dark → first bright)</h3>
    <div id="bridgeLine" class="mono">—</div>
  </div>

  <!-- 24-hour table -->
  <div class="section">
    <div class="muted" style="margin-bottom:8px">Today’s Planetary Hours (sunrise → sunrise)</div>
    <div class="hrs" id="list"></div>
  </div>

  <!-- 7x7 focus matrix -->
  <div class="section matrix">
    <h3 style="margin-bottom:8px">7×7 Focus Matrix (Day × Hour rulers)</h3>
    <div class="note" style="margin:4px 0 10px">Concise guidance for each hour ruler on each day ruler. Cells show symbol, name, and focus (no multipliers).</div>
    <div id="matrixHost"></div>
  </div>

  <!-- Weekly bridge table -->
  <div class="section matrix">
    <h3 style="margin-bottom:8px">Weekly Bridge Hours (last dark → next day’s first bright)</h3>
    <div id="weeklyBridge" class="note">—</div>
  </div>

  <!-- About / Help -->
  <div class="section">
    <details>
      <summary><strong>About & Help</strong></summary>
      <div style="margin-top:12px">
        <p class="sub"><strong>Multipliers</strong> are the product of the day ruler’s sidereal orbit (years) and the hour ruler’s sidereal orbit (years). The “day” begins at sunrise.</p>
        <p class="sub"><strong>Bright/Dark</strong> halves split the day into 12 variable daylight hours and 12 variable night hours.</p>
        <p class="sub">Focus lines summarize how the <em>day ruler</em> sets the climate while the <em>hour ruler</em> acts as agent. When they match, it’s low-friction (“oiled gears”).</p>
      </div>
    </details>
  </div>

</div>

<script>
(function(){
  // ---------------- planet data & texts ----------------
  const ORDER   = ["Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon"];
  const DAY_RULER = { 0:"Sun", 1:"Moon", 2:"Mars", 3:"Mercury", 4:"Jupiter", 5:"Venus", 6:"Saturn" };
  const WEEKDAY  = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  const SYMBOL   = { Sun:"☉", Moon:"☾", Mars:"♂", Mercury:"☿", Jupiter:"♃", Venus:"♀", Saturn:"♄" };
  const ORBIT_YEARS = { Sun:1.000, Moon:0.0748, Mercury:0.2408, Venus:0.6152, Mars:1.8808, Jupiter:11.862, Saturn:29.457 };

  // Day & hour foci (concise)
  const DAY_FOCUS = {
    Sun:"Lead, shine, self-expression",
    Moon:"Care, intuition, home",
    Mars:"Action, courage, cutting through",
    Mercury:"Communication, learning, trade",
    Jupiter:"Growth, teaching, wisdom",
    Venus:"Beauty, art, relationship, ease",
    Saturn:"Structure, discipline, boundaries"
  };
  const HOUR_FOCUS_BRIGHT = {
    Sun:"Lead, shine, self-expression",
    Moon:"Emotional clarity with warmth",
    Mars:"Bold action, decisive push",
    Mercury:"Communication, learning",
    Jupiter:"Abundance, teaching",
    Venus:"Beauty, art, connection",
    Saturn:"Structure, discipline"
  };
  const HOUR_FOCUS_DARK = {
    Sun:"Restore vitality, inner radiance",
    Moon:"Dream incubation, subconscious healing",
    Mars:"Inner discipline, calm resolve",
    Mercury:"Dream journal, quiet analysis",
    Jupiter:"Satisfying rest, quiet faith",
    Venus:"Dreamy affection, soothing",
    Saturn:"Grounding, stillness, solitude"
  };

  // ---------- DOM ----------
  const elClock = document.getElementById('headClock');
  const elLocEchoTop = document.getElementById('locEchoTop');
  const elLocEcho = document.getElementById('locEcho');

  const geoBtn = document.getElementById('geoBtn');
  const elTzSel = document.getElementById('tzSel');
  const elLat = document.getElementById('lat');
  const elLon = document.getElementById('lon');
  const setBtn = document.getElementById('setBtn');

  const datePick = document.getElementById('datePick');
  const timePick = document.getElementById('timePick');
  const useNowBtn = document.getElementById('useNow');
  const applyDTBtn = document.getElementById('applyDT');

  const elPrev = document.getElementById('prevPill');
  const elNext = document.getElementById('nextPill');

  const elTickFill = document.getElementById('tickfill');
  const elTitleSym = document.getElementById('titleSymbol');
  const elTitleName = document.getElementById('titleName');
  const elRange = document.getElementById('currentRange');
  const elCountdown = document.getElementById('countdown');

  const elDayPill = document.getElementById('dayRulerPill');
  const elHourPill = document.getElementById('hourRulerPill');
  const elPhase = document.getElementById('phaseBadge');
  const elDayFocus = document.getElementById('dayFocus');
  const elHourFocus = document.getElementById('hourFocus');
  const elMultBig = document.getElementById('multBig');
  const elSunline = document.getElementById('sunline');

  const elList = document.getElementById('list');
  const elMatrixHost = document.getElementById('matrixHost');
  const elBridgeLine = document.getElementById('bridgeLine');
  const elWeeklyBridge = document.getElementById('weeklyBridge');

  const copyLinkBtn = document.getElementById('copyLink');

  // ---------- state ----------
  let tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
  let lat = 40.7608, lon = -111.8910;
  let schedule = []; // 24 items
  let sunrise=null, sunset=null, nextSunrise=null;
  let currentDayRuler="Sun", weekdayName="Sunday";
  let customNow=null;
  let nextRecalcAt = 0;

  // ---------- helpers ----------
  const pad2 = n => String(n).padStart(2,'0');
  const fmt = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const nowClock = () => customNow ? new Date(customNow.getTime()) : new Date();
  function startOfLocalDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function chaldeanSequence(startPlanet, len){ const s=ORDER.indexOf(startPlanet), out=[]; for(let i=0;i<len;i++) out.push(ORDER[(s+i)%ORDER.length]); return out; }
  function planetWeight(p){ return ORBIT_YEARS[p] ?? 1; }

  // Anchor by sunrise: if before today’s sunrise, use yesterday’s computations
  function pickPlanetaryDayAnchor(_lat,_lon,now=new Date()){
    const d0 = startOfLocalDay(now);
    const t0 = SunCalc.getTimes(d0,_lat,_lon);
    if (now < t0.sunrise){
      const y0 = new Date(d0); y0.setDate(y0.getDate()-1);
      return { anchor:y0, times: SunCalc.getTimes(y0,_lat,_lon) };
    }
    return { anchor:d0, times:t0 };
  }

  function buildSchedule(_lat,_lon, now=new Date()){
    const { anchor, times } = pickPlanetaryDayAnchor(_lat,_lon,now);
    const _sunrise = times.sunrise, _sunset = times.sunset;
    if(!_sunrise || !_sunset) throw new Error("Sun never rises/sets for this date/location.");
    const tomorrow0 = new Date(anchor.getFullYear(), anchor.getMonth(), anchor.getDate()+1);
    const timesTomorrow = SunCalc.getTimes(tomorrow0,_lat,_lon);
    const _nextSunrise = timesTomorrow.sunrise;

    const dayLen=_sunset-_sunrise, nightLen=_nextSunrise-_sunset;
    const dayHour=dayLen/12, nightHour=nightLen/12;

    const wdIdx = anchor.getDay();
    const dayRuler = DAY_RULER[wdIdx];

    const daySeq = chaldeanSequence(dayRuler,12);
    const nightSeq = chaldeanSequence(daySeq[12%7],12);

    const out=[];
    for(let i=0;i<12;i++) out.push({ start:new Date(_sunrise.getTime()+i*dayHour), end:new Date(_sunrise.getTime()+(i+1)*dayHour), planet:daySeq[i], idx:i+1 });
    for(let i=0;i<12;i++) out.push({ start:new Date(_sunset.getTime()+i*nightHour), end:new Date(_sunset.getTime()+(i+1)*nightHour), planet:nightSeq[i], idx:13+i });

    nextRecalcAt = _nextSunrise.getTime();
    return { list:out, sunrise:_sunrise, sunset:_sunset, nextSunrise:_nextSunrise, dayRuler, weekdayName:WEEKDAY[wdIdx] };
  }

  // ---------- rendering ----------
  function renderList(){
    elList.innerHTML="";
    schedule.forEach(h=>{
      const div=document.createElement('div');
      div.className='hr';
      div.innerHTML = `<div class="t">${h.idx<=12?"Day":"Night"} ${(h.idx-1)%12+1} — <span class="k"><span class="sym">${SYMBOL[h.planet]}</span> ${h.planet}</span></div>
                       <div class="sub mono">${fmt(h.start)} – ${fmt(h.end)}</div>`;
      elList.appendChild(div);
    });
  }

  function updateHero(current, prev, next){
    elTitleSym.textContent = SYMBOL[current.planet];
    elTitleName.textContent = current.planet;
    elRange.textContent = `${fmt(current.start)} – ${fmt(current.end)}`;
    elPhase.textContent = current.idx<=12 ? "Bright" : "Dark";

    elDayPill.textContent  = `${SYMBOL[currentDayRuler]} ${currentDayRuler}`;
    elHourPill.textContent = `${SYMBOL[current.planet]} ${current.planet}`;

    elDayFocus.textContent  = DAY_FOCUS[currentDayRuler];
    const f = (current.idx<=12 ? HOUR_FOCUS_BRIGHT : HOUR_FOCUS_DARK)[current.planet];
    elHourFocus.textContent = `Focus: ${f}`;

    const mult = planetWeight(currentDayRuler) * planetWeight(current.planet);
    elMultBig.textContent = `x${mult.toFixed(3)}`;

    elPrev.textContent = `${SYMBOL[prev.planet]} ${prev.planet} ended ${fmt(prev.end)}`;
    elNext.textContent = `${SYMBOL[next.planet]} ${next.planet} starts ${fmt(next.start)}`;

    elSunline.textContent = `Sunrise ${fmt(sunrise)} • Sunset ${fmt(sunset)} • Next sunrise ${fmt(nextSunrise)}`;
  }

  function buildFocusMatrix(){
    // Days across: Saturn, Sun, Moon, Mars, Mercury, Jupiter, Venus (Chaldean order rotated)
    const cols = ["Saturn","Sun","Moon","Mars","Mercury","Jupiter","Venus"];
    // Rows in the exact daily sequence for a Saturn-anchored rotation (24h list starting at sunrise):
    // We’ll just list the hour rulers row order as: the ORDER starting point rotated
    const rows = ["Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon",
                  "Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon"]; // 14 to show pattern then we’ll display first 7 unique
    // We only need 7 rows; use ORDER itself for headline rows
    const hrs = ORDER.slice(); // 7 rows

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    trh.innerHTML = `<th>Hour ruler ↓ / Day ruler →</th>` + cols.map(d=>`<th><span class="k"><span class="sym">${SYMBOL[d]}</span> ${d}</span></th>`).join('');
    thead.appendChild(trh);
    table.appendChild(thead);

    const tb = document.createElement('tbody');
    hrs.forEach(hr=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<th><span class="k"><span class="sym">${SYMBOL[hr]}</span> ${hr}</span></th>` +
        cols.map(day=>{
          const line = (HOUR_FOCUS_BRIGHT[hr]||"") // show bright bias in matrix for readability
          return `<td><div class="k"><span class="sym">${SYMBOL[hr]}</span> ${hr}</div><div class="note">${line}</div></td>`;
        }).join('');
      tb.appendChild(tr);
    });
    table.appendChild(tb);

    elMatrixHost.innerHTML=""; elMatrixHost.appendChild(table);
  }

  function computeBridgeLine(){
    // last dark hour = hour 24 of anchor day. first bright = hour 1 of next day (computed already)
    const lastDark = schedule[23];
    const firstBright = schedule[0]; // The next day's first hour after nextSunrise is not in this schedule; but multiplier change is between 24→(next day’s 1). For display we show rulers & delta using currentDayRuler and next day's day ruler.
    // current day ruler:
    const todayRuler = currentDayRuler;
    // next day ruler in chaldean weekday order:
    const nextDayIdx = (ORDER.indexOf(todayRuler)+1)%7; // day rulers follow ORDER when moving weekday? (Sun..Sat) – safer: use weekdayName index
    // Better: find weekday → +1
    // We have weekdayName of anchor; compute next day:
    const wdIdx = WEEKDAY.indexOf(weekdayName);
    const nextDayRuler = DAY_RULER[(wdIdx+1)%7];

    const mLast  = planetWeight(todayRuler)    * planetWeight(lastDark.planet);
    const mFirst = planetWeight(nextDayRuler)  * planetWeight(firstBright.planet);
    const delta  = mFirst - mLast;

    elBridgeLine.textContent =
      `${weekdayName} last dark: ${SYMBOL[lastDark.planet]} ${lastDark.planet} → ${WEEKDAY[(wdIdx+1)%7]} first bright: ${SYMBOL[firstBright.planet]} ${firstBright.planet}  • ` +
      `x${mLast.toFixed(3)} → x${mFirst.toFixed(3)}  (Δ ${delta>=0?"+":""}${delta.toFixed(3)})`;
  }

  function buildWeeklyBridge(){
    // Build one full week starting from Saturn day in ORDER of weekday rulers:
    const weekCols = ["Saturn","Sun","Moon","Mars","Mercury","Jupiter","Venus"];
    // last dark hour rulers for each day = ORDER continued; compute simply via sequence from day ruler:
    function sequenceFrom(start){ const s=ORDER.indexOf(start); return ORDER.map((_,i)=>ORDER[(s+i)%7]); }

    // hour 24 planet for a given day ruler:
    function lastDarkHourPlanet(dayRuler){
      // Build the 24-hour sequence planets starting at sunrise dayRuler
      const daySeq = chaldeanSequence(dayRuler,12);
      const nightSeq = chaldeanSequence(daySeq[12%7],12);
      return nightSeq[11]; // 12th of night
    }
    function firstBrightPlanet(nextDayRuler){
      return nextDayRuler; // hour 1 of a day is the day ruler
    }

    const rows=[];
    weekCols.forEach((dayR,i)=>{
      const nextDay = weekCols[(i+1)%7];
      const pLast = lastDarkHourPlanet(dayR);
      const pFirst = firstBrightPlanet(nextDay);
      const mLast = planetWeight(dayR)*planetWeight(pLast);
      const mFirst = planetWeight(nextDay)*planetWeight(pFirst);
      rows.push({ day:dayR, last:pLast, mLast, nextDay, first:pFirst, mFirst, delta:mFirst-mLast });
    });

    const table=document.createElement('table');
    const thead=document.createElement('thead');
    thead.innerHTML = `<tr>
      <th>Day (last dark)</th><th>Multiplier</th><th>Next day (first bright)</th><th>Multiplier</th><th>Δ</th>
    </tr>`;
    table.appendChild(thead);
    const tb=document.createElement('tbody');
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><span class="k"><span class="sym">${SYMBOL[r.last]}</span> ${r.last}</span> on <span class="k"><span class="sym">${SYMBOL[r.day]}</span> ${r.day}</span></td>
        <td class="mono">x${r.mLast.toFixed(3)}</td>
        <td><span class="k"><span class="sym">${SYMBOL[r.first]}</span> ${r.first}</span> on <span class="k"><span class="sym">${SYMBOL[r.nextDay]}</span> ${r.nextDay}</span></td>
        <td class="mono">x${r.mFirst.toFixed(3)}</td>
        <td class="mono">${r.delta>=0?"+":""}${r.delta.toFixed(3)}</td>`;
      // highlight Venus → Saturn jump
      if(r.day==="Venus" && r.nextDay==="Saturn") tr.style.background="#fff8f2";
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    elWeeklyBridge.innerHTML=""; elWeeklyBridge.appendChild(table);
  }

  // ---------- live update ----------
  function updateNow(){
    if(!schedule.length) return;

    // rebuild right after next sunrise
    const now = nowClock();
    if(now.getTime() >= nextRecalcAt - 1000){ init(lat,lon,true); return; }

    // header clock
    elClock.textContent = now.toLocaleString([], { hour:'2-digit', minute:'2-digit' });

    const idx = schedule.findIndex(h => now >= h.start && now < h.end);
    const cur = (idx>=0)? schedule[idx] : schedule[schedule.length-1];
    const prev = schedule[(idx-1+24)%24];
    const next = schedule[(idx+1)%24];

    // countdown & progress
    const remain = cur.end - now;
    const mm = Math.floor(remain/60000), ss = Math.floor((remain%60000)/1000);
    elCountdown.textContent = `Next in ${pad2(mm)}:${pad2(ss)}`;
    const dur = cur.end - cur.start;
    elTickFill.style.width = `${Math.max(0,Math.min(100,100*(1-remain/dur)))}%`;

    // highlight
    [...document.querySelectorAll('.hr')].forEach((n,i)=> n.classList.toggle('now', i===idx));

    updateHero(cur,prev,next);
  }

  function init(newLat,newLon,force=false){
    if(!force && lat===newLat && lon===newLon && schedule.length) return;
    lat=Number(newLat); lon=Number(newLon);

    elLocEcho.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)} (${tz})`;
    elLocEchoTop.textContent = `Location ${lat.toFixed(4)}, ${lon.toFixed(4)} • Timezone: ${tz}`;

    const built = buildSchedule(lat,lon, nowClock());
    schedule = built.list;
    sunrise=built.sunrise; sunset=built.sunset; nextSunrise=built.nextSunrise;
    currentDayRuler=built.dayRuler; weekdayName=built.weekdayName;

    renderList();
    buildFocusMatrix();
    computeBridgeLine();
    buildWeeklyBridge();
    updateNow();
  }

  // ---------- controls ----------
  geoBtn.onclick = ()=>{
    if(!navigator.geolocation){ alert("Geolocation not supported."); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      elLat.value = pos.coords.latitude.toFixed(6);
      elLon.value = pos.coords.longitude.toFixed(6);
      init(pos.coords.latitude, pos.coords.longitude, true);
    }, e=>alert("Location error: "+e.message), { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
  };
  setBtn.onclick = ()=> init(parseFloat(elLat.value), parseFloat(elLon.value), true);

  useNowBtn.onclick = ()=>{
    customNow=null;
    const n=new Date();
    datePick.value = n.toISOString().slice(0,10);
    timePick.value = `${pad2(n.getHours())}:${pad2(n.getMinutes())}`;
    init(lat,lon,true);
  };
  applyDTBtn.onclick = ()=>{
    const ds = datePick.value || new Date().toISOString().slice(0,10);
    const ts = timePick.value || "00:00";
    const [Y,M,D]=ds.split('-').map(Number);
    const [h,m]=ts.split(':').map(Number);
    customNow = new Date(Y,M-1,D,h,m,0,0);
    init(lat,lon,true);
  };

  elTzSel.onchange = ()=>{
    tz = (elTzSel.value==="auto") ? (Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC") : elTzSel.value;
    init(lat,lon,true);
  };

  copyLinkBtn.onclick = async ()=>{
    const n = customNow || new Date();
    const q = new URLSearchParams({ lat:lat.toFixed(6), lon:lon.toFixed(6), tz, dt:n.toISOString() });
    const url = `${location.origin}${location.pathname}?${q.toString()}`;
    try{ await navigator.clipboard.writeText(url); copyLinkBtn.textContent="Copied!"; setTimeout(()=>copyLinkBtn.textContent="Copy link to this view",1500); }
    catch{ prompt("Copy this link:", url); }
  };

  // ---------- deep-link ----------
  (function fromQuery(){
    const p=new URLSearchParams(location.search);
    if(p.has('lat')&&p.has('lon')){ lat=parseFloat(p.get('lat')); lon=parseFloat(p.get('lon')); }
    if(p.has('tz')) tz=p.get('tz');
    if(p.has('dt')){ const d=new Date(p.get('dt')); if(!isNaN(d)) customNow=d; }
    elLat.value=lat.toFixed(6); elLon.value=lon.toFixed(6);
    const t = customNow||new Date();
    datePick.value=t.toISOString().slice(0,10);
    timePick.value=`${pad2(t.getHours())}:${pad2(t.getMinutes())}`;
    if(tz!=="auto" && tz!=="UTC"){ const opt=document.createElement('option'); opt.value=tz; opt.textContent=tz; elTzSel.appendChild(opt); elTzSel.value=tz; }
    else if(tz==="UTC"){ elTzSel.value="UTC"; }
  })();

  // ---------- boot ----------
  if(!elLat.value) elLat.value="40.7608";
  if(!elLon.value) elLon.value="-111.8910";
  useNowBtn.click(); // set pickers

  init(lat,lon,true);

  function tick(){ updateNow(); requestAnimationFrame(tick); }
  tick();

})();
</script>
</body>
</html>
