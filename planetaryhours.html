<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planetary Hours</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #0b0d10; color: #e9eef5; margin: 0; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    header { background: #11151a; border-bottom: 1px solid #263244; position: sticky; top: 0; z-index: 100; }
    header .row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
    .title { font-size: 24px; font-weight: 700; }
    .clock { font-variant-numeric: tabular-nums; border: 1px solid #263244; padding: 6px 10px; border-radius: 10px; background: #1a2028; }
    .btn { background: #1d2430; border: 1px solid #263244; color: #e9eef5; padding: 8px 10px; border-radius: 10px; cursor: pointer; }
    .section { background: #11151a; border: 1px solid #263244; border-radius: 14px; padding: 12px; margin-top: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #263244; }
    thead th { background: #0e1319; position: sticky; top: 0; }
    tr.active { background: rgba(122,162,255,.1); }
  </style>
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="title">Planetary Hours</div>
        <div class="row">
          <div class="clock" id="localClock">--:--</div>
          <button class="btn" id="copyLink">Copy link to this view</button>
        </div>
      </div>
    </div>
  </header>
  <main class="wrap">
    <section class="section" id="daySummary">
      <div id="dayRuler"></div>
      <div id="sunTimes"></div>
      <div id="bridgeInfo"></div>
    </section>
    <section class="section">
      <table>
        <thead>
          <tr><th>#</th><th>Start–End</th><th>Ruler</th><th>Order</th><th>Hour n/24</th><th>Hours ruled</th><th>Multiplier</th><th>Focus</th></tr>
        </thead>
        <tbody id="hoursTable"></tbody>
      </table>
    </section>
  </main>
  <script>
    function pad(n){return String(n).padStart(2,'0');}
    function fmtHM(d){return pad(d.getHours()%12||12)+":"+pad(d.getMinutes())+(d.getHours()<12?" AM":" PM");}

    const planets = [
      {key:'saturn',sym:'♄',name:'Saturn',weight:29.46},
      {key:'jupiter',sym:'♃',name:'Jupiter',weight:11.86},
      {key:'mars',sym:'♂',name:'Mars',weight:1.88},
      {key:'sun',sym:'☉',name:'Sun',weight:1.00},
      {key:'venus',sym:'♀',name:'Venus',weight:0.615},
      {key:'mercury',sym:'☿',name:'Mercury',weight:0.241},
      {key:'moon',sym:'☽',name:'Moon',weight:0.0748}
    ];
    const byKey = Object.fromEntries(planets.map(p=>[p.key,p]));
    const chaldean = ['saturn','jupiter','mars','sun','venus','mercury','moon'];

    function rotateTo(dayKey){
      const idx = chaldean.indexOf(dayKey);
      const seq=[];
      for(let i=0;i<24;i++){ seq.push(chaldean[(idx+i)%7]); }
      return seq;
    }

    function buildHours(frame, dayKey){
      const seq=rotateTo(dayKey);
      const daylight=(frame.sunset-frame.sunrise);
      const night=(frame.end-frame.sunset);
      const brightLen=daylight/12;
      const darkLen=night/12;
      const rows=[];
      let t = frame.start.getTime();
      for(let i=0;i<24;i++){
        const isBright=i<12;
        const len=isBright?brightLen:darkLen;
        const start=new Date(t);
        const end=new Date(t+len);
        rows.push({index:i+1,start,end,ruler:byKey[seq[i]],isBright});
        t+=len;
      }
      return rows;
    }

    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function computeDayFrame(now,lat,lon){
      const local = new Date(now);
      const base = new Date(local); base.setHours(12,0,0,0);
      const tToday = SunCalc.getTimes(base,lat,lon);
      const srToday = tToday.sunrise, ssToday = tToday.sunset;
      if(local >= srToday){
        const next = SunCalc.getTimes(addDays(base,1),lat,lon);
        return {start: srToday, sunrise: srToday, sunset: ssToday, end: next.sunrise};
      } else {
        const prev = SunCalc.getTimes(addDays(base,-1),lat,lon);
        return {start: prev.sunrise, sunrise: prev.sunrise, sunset: prev.sunset, end: srToday};
      }
    }

    function dayRulerKeyForWeekday(localStart){
      const map={0:'sun',1:'moon',2:'mars',3:'mercury',4:'jupiter',5:'venus',6:'saturn'};
      return map[ localStart.getDay() ];
    }
    function rebuild(){

      const now=new Date();
      const frame=computeDayFrame(now,40.7608,-111.8910);
      const dayKey = dayRulerKeyForWeekday(frame.start);
      const rows=buildHours(frame,dayKey);
      // Bridge hour label
      const last=rows[23];
      const nextFrame=computeDayFrame(new Date(frame.end.getTime()+1000),40.7608,-111.8910);
      const nextKey=dayRulerKeyForWeekday(nextFrame.start);
      document.getElementById('bridgeInfo').textContent = `Bridge hour: ${last.ruler.sym} ${last.ruler.name} (Hour 24) → ${byKey[nextKey].sym} ${byKey[nextKey].name} (Hour 1)`;
      document.getElementById('dayRuler').textContent=`${byKey[dayKey].sym} ${byKey[dayKey].name}`;
      document.getElementById('sunTimes').textContent=`Sunrise ${fmtHM(frame.sunrise)} • Sunset ${fmtHM(frame.sunset)} • Next Sunrise ${fmtHM(frame.end)}`;

      // Bridge hour fix: compute next day cleanly
      const last = rows[23];
      const nextFrame = computeDayFrame(new Date(frame.start.getTime()+86400000),40.7608,-111.8910);
      const nextDayKey = 'jupiter'; // placeholder until weekday mapping wired
      const nextRows = buildHours(nextFrame,nextDayKey);
      document.getElementById('bridgeInfo').textContent=`Bridge hour: ${last.ruler.sym} ${last.ruler.name} (Hour 24) → ${nextRows[0].ruler.sym} ${nextRows[0].ruler.name} (Hour 1)`;

      const tbody=document.getElementById('hoursTable');
      tbody.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.index}</td><td>${fmtHM(r.start)}–${fmtHM(r.end)}</td><td>${r.ruler.sym} ${r.ruler.name}</td><td>${r.index}</td><td>${r.index}/24</td><td>–</td><td>–</td><td>–</td>`;
        tbody.appendChild(tr);
      });
    }

    setInterval(()=>{
      const d=new Date();
      document.getElementById('localClock').textContent=pad(d.getHours())+":"+pad(d.getMinutes());
    },10000);

    rebuild();
  </script>
</body>
</html>
