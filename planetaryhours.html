<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planetary Hours</title>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<style>
  :root{
    --fg:#111; --muted:#666; --border:#e6e6e6; --chip:#f6f6f6; --accent:#111;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  body{ margin:14px; color:var(--fg); }
  .wrap{ max-width:1080px; margin-inline:auto; }
  h1{ font-size:32px; margin:0 0 4px; }
  .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  .muted{ color:var(--muted); }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .card{ border:1px solid var(--border); border-radius:14px; padding:14px; background:#fff; }
  .chip{ background:var(--chip); border:1px solid var(--border); padding:8px 12px; border-radius:999px; display:inline-flex; gap:8px; align-items:center; }
  .chip.big{ font-size:20px; padding:10px 14px; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .grid3{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
  .bar{ height:10px; background:#eee; border-radius:999px; overflow:hidden; }
  .bar>div{ height:100%; width:0%; background:var(--accent); }
  input, select, button{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; }
  button{ cursor:pointer; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ padding:10px; border-top:1px solid var(--border); vertical-align:top; }
  .titleXL{ font-size:56px; font-weight:800; line-height:1.05; display:flex; gap:14px; align-items:center; }
  .planetSym{ font-size:40px; line-height:1; }
  .divider{ border-top:1px solid var(--border); margin:12px 0; }
  .sectionTitle{ font-weight:700; margin-bottom:6px; }
  .pillRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .tag{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:var(--chip); }
  .phaseTag{ background:#eee; border-color:#ddd; }
  .centerRow{ display:flex; align-items:center; justify-content:center; gap:10px; }
  .hint{ font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">

  <!-- Top line (system/local datetime + tz + quick planet links) -->
  <div class="row muted mono" id="topline">—</div>

  <!-- Controls -->
  <div class="card" style="margin:12px 0;">
    <div class="grid2">
      <div>
        <div class="sectionTitle">Location</div>
        <div class="row">
          <button id="btnMyLoc">Use my location</button>
          <select id="btnUTC">
            <option value="utc">UTC (0°, 0°)</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="search" placeholder="Search place (e.g., Salt Lake City)" style="min-width:280px" />
          <button id="btnFind">Find</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>Lat <input id="lat" size="10" class="mono" /></label>
          <label>Lon <input id="lon" size="10" class="mono" /></label>
          <button id="btnSet">Set</button>
        </div>
        <div class="hint mono" id="locEcho" style="margin-top:6px;">—</div>
      </div>

      <div>
        <div class="sectionTitle">Time &amp; Timezone</div>
        <div class="row">
          <select id="tzSel" title="Timezone"></select>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>Date <input id="dateInput" type="date" /></label>
          <label>Time <input id="timeInput" type="time" /></label>
          <button id="btnNow">Use now</button>
          <button id="btnApply">Apply</button>
        </div>
        <div class="hint mono" id="clockEcho" style="margin-top:6px;">Using system clock</div>
      </div>
    </div>
  </div>

  <!-- Current hour -->
  <div class="card" id="hourCard">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div>
        <div class="titleXL" id="titleXL"><span class="planetSym">☉</span><span>Sun</span></div>
        <div class="row" style="margin-top:8px; gap:10px;">
          <div class="chip mono big" id="rangeChip">—</div>
          <div class="chip mono big" id="nextChip">Next in —</div>
          <div class="chip big" id="weekdayChip">—</div>
        </div>
      </div>
      <div class="centerRow">
        <div class="chip" id="prevPill">—</div>
        <div class="chip" id="nextPill">—</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="sectionTitle">Hour ruler</div>
    <div class="bar"><div id="progress"></div></div>

    <div class="grid3" style="margin-top:14px;">
      <div>
        <div class="sectionTitle">Day ruler</div>
        <div class="row" id="dayBlock">—</div>
      </div>
      <div>
        <div class="sectionTitle">Hour ruler</div>
        <div class="row" id="hourBlock">—</div>
      </div>
      <div>
        <div class="sectionTitle">Multiplier</div>
        <div id="multBlock" style="font-size:30px; font-weight:800;">—</div>
        <div class="hint">Power = day orbit × hour orbit</div>
      </div>
    </div>

    <!-- NEW: Interaction insight block -->
    <div class="divider"></div>
    <div>
      <div class="sectionTitle">Interaction insight</div>
      <div id="interactionTitle" class="tiny mono" style="margin-bottom:6px;">—</div>
      <ul id="interactionList" style="margin:0 0 8px 18px; padding:0;"></ul>
      <div id="interactionCaution" class="tiny muted">—</div>
    </div>

    <div class="divider"></div>

    <div class="grid2">
      <div>
        <div class="sectionTitle">Sunrise / Sunset</div>
        <div id="sunRow" class="mono">—</div>
      </div>
      <div>
        <div class="sectionTitle">Bridge hour (last dark hour)</div>
        <div id="bridgeRow" class="mono">—</div>
        <div class="hint" id="deltaEcho">Δ at daybreak: —</div>
      </div>
    </div>
  </div>

  <!-- Schedule table -->
  <div class="card" style="margin-top:12px;">
    <div class="row" style="justify-content:space-between; align-items:baseline;">
      <div class="sectionTitle">Today’s Planetary Hours</div>
      <div class="hint" id="ruledByEcho">—</div>
    </div>
    <table id="hoursTable">
      <thead>
        <tr>
          <th class="mono">#</th>
          <th>Phase</th>
          <th class="mono">Start</th>
          <th class="mono">End</th>
          <th>Ruler</th>
          <th>Focus</th>
          <th class="mono">Multiplier</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* =========================
   Planet data & helpers
========================= */
const ORDER   = ["Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon"];
const SYMBOL  = { Saturn:"♄", Jupiter:"♃", Mars:"♂", Sun:"☉", Venus:"♀", Mercury:"☿", Moon:"☾" };
const WEEKDAY = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const DAY_RULER = { 0:"Sun", 1:"Moon", 2:"Mars", 3:"Mercury", 4:"Jupiter", 5:"Venus", 6:"Saturn" }; // JS 0=Sun
// Sidereal orbital periods (years)
const ORBIT_Y = { Sun:1.000, Moon:0.07479, Mercury:0.240846, Venus:0.615, Mars:1.8808, Jupiter:11.862, Saturn:29.4571 };

const FOCUS = {
  Sun    : { Bright:"Lead, shine, self-expression",           Dark:"Restore vitality, inner radiance" },
  Moon   : { Bright:"Deep self-care, nurture, memory",        Dark:"Dream incubation, subconscious healing" },
  Mars   : { Bright:"Bold action, decisive push",             Dark:"Inner discipline, calm resolve" },
  Mercury: { Bright:"Communication, learning, trade",         Dark:"Drafts, analysis, silent planning" },
  Jupiter: { Bright:"Abundance, teaching, wise growth",       Dark:"Satisfying rest, quiet faith" },
  Venus  : { Bright:"Beauty, art, connection",                Dark:"Reconciliation, gentle affection" },
  Saturn : { Bright:"Structure, duty, pruning",               Dark:"Grounding, stillness, solitude" }
};

// Day “climate” & Hour “agent” (bright/dark verbs)
const CLIMATE = {
  Sun:    "visibility, self-definition, leadership, vitality",
  Moon:   "care, home, memory, body tides",
  Mars:   "decisive action, cutting, heat, contests",
  Mercury:"thinking, messages, trade, documents",
  Jupiter:"growth, blessing, teaching, law, confidence",
  Venus:  "harmony, bonds, beauty, pleasures",
  Saturn: "time, limits, structure, duty, reputation"
};
const AGENT = {
  Sun:    {Bright:"show, declare, lead",        Dark:"re-center, restore, set intent"},
  Moon:   {Bright:"nurture, adjust, care",      Dark:"soothe, digest, remember"},
  Mars:   {Bright:"push, cut, assert",          Dark:"steel yourself, train calmly"},
  Mercury:{Bright:"speak, arrange, trade",      Dark:"draft, analyze, plan quietly"},
  Jupiter:{Bright:"teach, grant, expand",       Dark:"consolidate, trust, review"},
  Venus:  {Bright:"beautify, connect, harmonize", Dark:"reconcile, soften, comfort"},
  Saturn: {Bright:"structure, commit, prune",   Dark:"endure, ground, concentrate"}
};
const CAUTIONS = {
  Sun:    "ego glare or burnout; share light, don’t scorch.",
  Moon:   "mood loops; don’t let feelings drive decisions.",
  Mars:   "impatience and nicks; warm up, aim, then act.",
  Mercury:"analysis-paralysis; ship a draft.",
  Jupiter:"over-promising; anchor expansion in steps.",
  Venus:  "people-pleasing; keep boundaries.",
  Saturn: "rigidity or bleakness; set limits with care."
};

const fmtHM = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
const pad2  = n => String(n).padStart(2,'0');

/* =========================
   App state
========================= */
const state = {
  lat: 40.7608, lon: -111.8910,  // default SLC
  tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
  useCustomDT: false,
  custom: null, // Date when custom is active
  schedule: [],
  sunrise:null, sunset:null, nextSunrise:null,
  dayRuler: null,
  nowClockText:""
};

/* =========================
   Build schedule
========================= */
function chaldeanSequence(startPlanet, n){
  const idx = ORDER.indexOf(startPlanet);
  const seq = [];
  for(let i=0;i<n;i++) seq.push(ORDER[(idx+i)%ORDER.length]);
  return seq;
}

function buildSchedule(baseDate, lat, lon){
  const timesToday = SunCalc.getTimes(baseDate, lat, lon);
  if(!timesToday.sunrise || !timesToday.sunset) throw new Error("No sunrise/sunset for this date/location.");
  const sunrise = timesToday.sunrise, sunset = timesToday.sunset;

  const tomorrow = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate()+1);
  const timesTomorrow = SunCalc.getTimes(tomorrow, lat, lon);
  const nextSunrise = timesTomorrow.sunrise;

  const dayLen = sunset - sunrise, nightLen = nextSunrise - sunset;
  const dayHour = dayLen/12, nightHour = nightLen/12;

  const weekday = baseDate.getDay();
  const dayRuler = DAY_RULER[weekday];

  const daySeq   = chaldeanSequence(dayRuler, 12);
  const nightSeq = chaldeanSequence(daySeq[12%7], 12);

  const sched = [];
  // 12 bright hours
  for(let i=0;i<12;i++){
    const start = new Date(sunrise.getTime()+i*dayHour);
    const end   = new Date(sunrise.getTime()+(i+1)*dayHour);
    sched.push({idx:i+1, phase:"Bright", planet:daySeq[i], start, end});
  }
  // 12 dark hours
  for(let i=0;i<12;i++){
    const start = new Date(sunset.getTime()+i*nightHour);
    const end   = new Date(sunset.getTime()+(i+1)*nightHour);
    sched.push({idx:13+i, phase:"Dark", planet:nightSeq[i], start, end});
  }

  return {sched, sunrise, sunset, nextSunrise, dayRuler, weekdayName: WEEKDAY[weekday]};
}

/* =========================
   Renderers
========================= */
function interactionInsight(hourPlanet, dayPlanet, phase){
  const climate = CLIMATE[dayPlanet];
  const verb    = AGENT[hourPlanet][phase];
  const fH      = (phase==='Bright' ? FOCUS[hourPlanet].Bright : FOCUS[hourPlanet].Dark);
  const fD      = (phase==='Bright' ? FOCUS[dayPlanet].Bright  : FOCUS[dayPlanet].Dark);

  return {
    title: `${SYMBOL[hourPlanet]} ${hourPlanet} hour on ${SYMBOL[dayPlanet]} ${dayPlanet} day (${phase.toLowerCase()})`,
    lines: [
      `Climate: ${dayPlanet} day → ${climate}.`,
      `Agent: ${hourPlanet} hour → ${verb}.`,
      `Use it for: ${hourPlanet} → ${fH}; ${dayPlanet} → ${fD}.`
    ],
    caution: `Watch-out: ${CAUTIONS[hourPlanet]}`
  };
}

function renderAll(){
  const now = state.useCustomDT && state.custom ? new Date(state.custom) : new Date();
  state.nowClockText = `${now.toLocaleString([], {month:'short', day:'numeric'})}, ${now.getFullYear()} • ${fmtHM(now)} • Timezone: ${state.tz}`;
  document.getElementById('topline').textContent = state.nowClockText + `   Location ${state.lat.toFixed(4)}, ${state.lon.toFixed(4)}   (TZ: ${state.tz})`;

  // rebuild schedule anchored to local date (midnight local)
  const base = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const b = buildSchedule(base, state.lat, state.lon);
  state.schedule = b.sched; state.sunrise=b.sunrise; state.sunset=b.sunset; state.nextSunrise=b.nextSunrise; state.dayRuler=b.dayRuler;

  // find current hour
  const t=now.getTime();
  let curIdx = state.schedule.findIndex(h=> t>=h.start.getTime() && t<h.end.getTime());
  if(curIdx<0){ // if between last dark end and next sunrise (rare rounding), fall back to last
    curIdx = state.schedule.length-1;
  }
  const cur  = state.schedule[curIdx];
  const prev = state.schedule[(curIdx-1+24)%24];
  const next = state.schedule[(curIdx+1)%24];

  // Header title
  document.getElementById('titleXL').innerHTML = `<span class="planetSym">${SYMBOL[cur.planet]}</span><span>${cur.planet}</span>`;
  document.getElementById('rangeChip').textContent = `${fmtHM(cur.start)} – ${fmtHM(cur.end)}`;
  // countdown
  const remainMs = cur.end.getTime()-t;
  const mm = Math.floor((remainMs/1000/60)%60);
  const hh = Math.floor(remainMs/1000/3600);
  document.getElementById('nextChip').textContent = `Next in ${hh?hh+":" : ""}${pad2(mm)}`;
  // weekday chips: show clock weekday (JS getDay)
  const wd = now.getDay();
  document.getElementById('weekdayChip').textContent = WEEKDAY[wd];

  // previous/next pills (symmetry + their boundary times)
  document.getElementById('prevPill').innerHTML = `${SYMBOL[prev.planet]} ${prev.planet}<span class="hint mono">ended ${fmtHM(prev.end)}</span>`;
  document.getElementById('nextPill').innerHTML = `${SYMBOL[next.planet]} ${next.planet}<span class="hint mono">starts ${fmtHM(next.start)}</span>`;

  // progress bar
  const dur = cur.end - cur.start;
  const prog = 100 * (1 - (remainMs / dur));
  document.getElementById('progress').style.width = `${Math.max(0,Math.min(100,prog))}%`;

  // Day & hour blocks + multiplier
  const dayHTML  = `<span class="chip">${SYMBOL[state.dayRuler]} ${state.dayRuler}</span><span class="muted">Focus:</span> ${FOCUS[state.dayRuler].Bright} / ${FOCUS[state.dayRuler].Dark}`;
  document.getElementById('dayBlock').innerHTML = dayHTML;

  const hourHTML = `<span class="chip">${SYMBOL[cur.planet]} ${cur.planet}</span><span class="tag phaseTag">${cur.phase}</span><div class="muted" style="margin-top:6px;">Focus: ${FOCUS[cur.planet][cur.phase]}</div>`;
  document.getElementById('hourBlock').innerHTML = hourHTML;

  const mult = ORBIT_Y[state.dayRuler] * ORBIT_Y[cur.planet];
  document.getElementById('multBlock').textContent = `x${mult.toFixed(3)}`;

  // Interaction insight (NEW)
  const ii = interactionInsight(cur.planet, state.dayRuler, cur.phase);
  document.getElementById('interactionTitle').textContent = ii.title;
  const ul = document.getElementById('interactionList');
  ul.innerHTML = ''; ii.lines.forEach(t=>{
    const li=document.createElement('li'); li.textContent=t; ul.appendChild(li);
  });
  document.getElementById('interactionCaution').textContent = ii.caution;

  // Sunrise / Sunset
  document.getElementById('sunRow').textContent =
    `Sunrise ${fmtHM(state.sunrise)} • Sunset ${fmtHM(state.sunset)} • Next sunrise ${fmtHM(state.nextSunrise)}`;
  document.getElementById('ruledByEcho').textContent = `${b.weekdayName} ruled by ${state.dayRuler}`;

  // Bridge hour (last dark hour)
  // last dark hour is idx 24
  const lastDark = state.schedule[23];
  const nextDayFirst = state.schedule[0]; // first bright hour of current day (already rebuilt for "now")
  const lastDarkR = lastDark.planet, nextFirstR = nextDayFirst.planet;
  const delta = ORBIT_Y[state.dayRuler] * ORBIT_Y[nextFirstR] - ORBIT_Y[state.dayRuler] * ORBIT_Y[lastDarkR];
  document.getElementById('bridgeRow').textContent =
    `${fmtHM(lastDark.start)}–${fmtHM(lastDark.end)} • Last dark ruler: ${SYMBOL[lastDarkR]} ${lastDarkR}  → Next day first ruler: ${SYMBOL[nextFirstR]} ${nextFirstR}`;
  document.getElementById('deltaEcho').textContent = `Δ at daybreak: ${delta>=0?"+":""}${delta.toFixed(3)}`;

  // Table
  const tbody = document.querySelector('#hoursTable tbody'); tbody.innerHTML='';
  state.schedule.forEach(h=>{
    const tr = document.createElement('tr');
    const multH = ORBIT_Y[state.dayRuler] * ORBIT_Y[h.planet];
    tr.innerHTML = `
      <td class="mono">${h.idx}</td>
      <td>${h.phase}</td>
      <td class="mono">${fmtHM(h.start)}</td>
      <td class="mono">${fmtHM(h.end)}</td>
      <td>${SYMBOL[h.planet]} ${h.planet}</td>
      <td>${FOCUS[h.planet][h.phase]}</td>
      <td class="mono">x${multH.toFixed(3)}</td>
    `;
    tbody.appendChild(tr);
  });

  // Echo lines
  document.getElementById('locEcho').textContent = `${state.lat.toFixed(4)}, ${state.lon.toFixed(4)}  (${state.tz})`;
  document.getElementById('clockEcho').textContent = state.useCustomDT ? `Custom datetime: ${now.toLocaleString()}` : 'Using system clock';
}

/* =========================
   Controls
========================= */
function populateTZ(){
  const sel=document.getElementById('tzSel'); sel.innerHTML='';
  // Provide system + a few common TZs; user can still run with system default
  const common = [
    state.tz, "UTC", "America/Denver", "America/Los_Angeles", "America/New_York",
    "Europe/London","Europe/Paris","Europe/Berlin","Asia/Tokyo","Australia/Sydney"
  ];
  const seen=new Set();
  common.forEach(z=>{
    if(seen.has(z)) return; seen.add(z);
    const opt=document.createElement('option'); opt.value=z; opt.textContent=z+(z===state.tz?" (system)":"");
    sel.appendChild(opt);
  });
  sel.value = state.tz;
  sel.onchange = ()=>{ state.tz = sel.value; renderAll(); };
}
populateTZ();

document.getElementById('btnMyLoc').onclick = ()=>{
  if(!navigator.geolocation){ alert("Geolocation not supported."); return; }
  navigator.geolocation.getCurrentPosition(p=>{
    state.lat=p.coords.latitude; state.lon=p.coords.longitude;
    document.getElementById('lat').value=state.lat.toFixed(6);
    document.getElementById('lon').value=state.lon.toFixed(6);
    renderAll();
  }, err=> alert("Location error: "+err.message), {enableHighAccuracy:true, timeout:10000, maximumAge:60000});
};
// UTC button simply sets tz and lat/lon to 0/0 quickly (still computes by astro, not tz alone)
document.getElementById('btnUTC').onchange = ()=>{
  state.lat = 0; state.lon = 0;
  document.getElementById('lat').value="0.000000";
  document.getElementById('lon').value="0.000000";
  state.tz = "UTC";
  document.getElementById('tzSel').value="UTC";
  renderAll();
};
// Find place (Nominatim)
document.getElementById('btnFind').onclick = async ()=>{
  const q = document.getElementById('search').value.trim();
  if(!q){ alert("Enter a place to search."); return; }
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, {headers:{'Accept-Language':'en'}}); const arr = await res.json();
    if(!arr.length){ alert("No results."); return; }
    const best = arr[0];
    state.lat = parseFloat(best.lat); state.lon = parseFloat(best.lon);
    document.getElementById('lat').value=state.lat.toFixed(6);
    document.getElementById('lon').value=state.lon.toFixed(6);
    renderAll();
  }catch(e){ alert("Search failed."); }
};
// Set lat/lon manually
document.getElementById('btnSet').onclick = ()=>{
  const la=parseFloat(document.getElementById('lat').value);
  const lo=parseFloat(document.getElementById('lon').value);
  if(Number.isNaN(la)||Number.isNaN(lo)){ alert("Invalid coordinates."); return; }
  state.lat=la; state.lon=lo; renderAll();
};

// Time controls
document.getElementById('btnNow').onclick = ()=>{
  state.useCustomDT=false; state.custom=null;
  const now = new Date();
  document.getElementById('dateInput').value = now.toISOString().slice(0,10);
  document.getElementById('timeInput').value = now.toTimeString().slice(0,5);
  renderAll();
};
document.getElementById('btnApply').onclick = ()=>{
  const d = document.getElementById('dateInput').value;
  const t = document.getElementById('timeInput').value;
  if(!d||!t){ alert("Pick date and time."); return; }
  // Construct local datetime for current TZ (state.tz) via Date parts
  const [y,m,dd]=d.split('-').map(Number);
  const [hh,mm]=t.split(':').map(Number);
  // Build in local machine tz, then render; we keep “useCustomDT” true so ticker won’t override
  state.custom = new Date(y, m-1, dd, hh, mm, 0, 0);
  state.useCustomDT = true; renderAll();
};

/* =========================
   Ticker (updates every ~second)
========================= */
function tick(){
  if(!state.useCustomDT){ renderAll(); }
  requestAnimationFrame(tick);
}

/* =========================
   Init defaults
========================= */
(function init(){
  // seed inputs
  document.getElementById('lat').value = state.lat.toFixed(6);
  document.getElementById('lon').value = state.lon.toFixed(6);
  const now = new Date();
  document.getElementById('dateInput').value = now.toISOString().slice(0,10);
  document.getElementById('timeInput').value = now.toTimeString().slice(0,5);
  renderAll();
  tick();
})();
</script>
</body>
</html>
