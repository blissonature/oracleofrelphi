<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planetary Hours</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#11151a; --muted:#96a1b0; --text:#e9eef5; --ring:#263244;
      --chip:#1a2028; --accent:#7aa2ff; --ok:#59d69e; --warn:#ffd166; --bad:#ef6b73;
      --saturn:#c0b28a; --sun:#ffb100; --moon:#c9d6ff; --mars:#ff6b6b; --mercury:#8bd3ff; --jupiter:#9dde7a; --venus:#ff9ad1;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;}
    h1{font-size:28px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px;margin-top:12px}
    button,select,input{background:var(--chip);border:1px solid var(--ring);color:var(--text);border-radius:10px;padding:8px 10px}
    button.primary{background:var(--accent);border-color:transparent;color:#0b0d10;font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:6px 10px;font-size:13px}
    .tiny{font-size:12px;color:var(--muted)}
    .hr-badge{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid var(--ring);background:#0f1318;color:var(--muted)}
    .ticker{position:relative;height:12px;background:#0e1319;border:1px solid var(--ring);border-radius:999px;overflow:hidden}
    .tick-bar{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--accent),#94b6ff)}
    .tick-marker{position:absolute;top:-6px;bottom:-6px;width:2px;background:var(--ring)}
    .now-row{background:#0e141b;border:1px solid #2b3a4f}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{font-size:13px;padding:10px}
    thead th{position:sticky;top:0;background:var(--panel);z-index:1;border-bottom:1px solid var(--ring)}
    tbody tr{background:#0e141b;border:1px solid var(--ring)}
    tbody tr.now{outline:2px solid var(--accent);}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .side-pills{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .side-left{justify-self:start}
    .side-right{justify-self:end}
    .center-block{display:grid;gap:6px;justify-items:center}
    .legend{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .matrix{overflow:auto}
    .matrix table td{white-space:nowrap}
    .testbar{display:flex;gap:8px;align-items:center}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card" id="header">
      <div class="flex-between">
        <div>
          <h1>Planetary Hours</h1>
          <div class="sub">Singleâ€‘file app â€¢ sunrise â†’ sunrise</div>
        </div>
        <div class="row">
          <div class="mono" id="liveClock">--:--</div>
          <button id="copyLinkBtn" class="primary" aria-describedby="copyStatus">Copy link to this view</button>
          <span id="copyStatus" class="tiny" aria-live="polite"></span>
        </div>
      </div>
    </div>

    <!-- Location & Time Controls -->
    <div class="card" id="controls">
      <div class="row" id="locRow">
        <button id="useGeo">Use my location</button>
        <select id="tzSelect"></select>
        <input id="latInput" class="mono" placeholder="Lat" size="10" />
        <input id="lonInput" class="mono" placeholder="Lon" size="10" />
        <button id="setLatLon">Set</button>
        <div class="tiny mono" id="locEcho">â€”</div>
      </div>
      <div class="row" id="dtRow" style="margin-top:8px">
        <label class="row" style="gap:6px">
          <input type="checkbox" id="useSystem" checked /> Use system date/time
        </label>
        <input type="date" id="datePick" disabled />
        <input type="time" id="timePick" disabled />
        <button id="applyDt" disabled>Apply</button>
        <div class="tiny">Day runs sunrise â†’ sunrise.</div>
      </div>
      <div class="row" id="modeRow" style="margin-top:8px">
        <label>Mode:</label>
        <select id="modeSelect">
          <option value="sidereal">Sidereal</option>
          <option value="ratio">Ratio</option>
          <option value="hybrid">Hybrid</option>
        </select>
      </div>
    </div>

    <!-- Day Summary -->
    <div class="card" id="summary">
      <div class="row" id="dayRulerPill">â€”</div>
      <div class="row" style="margin-top:8px">
        <div class="pill">Sunrise <span class="mono" id="sunrise">--:--</span></div>
        <div class="pill">Sunset <span class="mono" id="sunset">--:--</span></div>
        <div class="pill">Next Sunrise <span class="mono" id="nextSunrise">--:--</span></div>
        <div class="pill" id="bridgeLine">Bridge: â€”</div>
        <div class="tiny warn" id="polarNotice" hidden>Sun never rises/sets for this date/location. Matrix & bridges remain available.</div>
      </div>
    </div>

    <!-- Current Hour Band (Hero) -->
    <div class="card" id="hero">
      <div class="ticker" id="ticker">
        <div class="tick-bar" id="tickBar"></div>
        <div class="tick-marker" id="markStart"></div>
        <div class="tick-marker" id="markSunset"></div>
        <div class="tick-marker" id="markEnd"></div>
      </div>
      <!-- removed the three time labels under the progress bar per request -->
      <div class="side-pills" style="margin-top:10px">
        <div class="pill side-left" id="nextPill">Next: â€”</div>
        <div class="center-block">
          <div class="pill" id="currentPill">Current: â€”</div>
          <div style="font-size:22px" class="mono" id="multiplier">x0.000</div>
          <div class="tiny mono" id="formulaLine">â€”</div>
          <div class="tiny mono" id="metaLine">Hour â€”/24 â€¢ â€” â€¢ Ruler appearance: â€” â€¢ Hours ruled B/D/T: â€”</div>
          <div class="tiny mono" id="approachLine">â€”</div>
          <div class="legend" id="legendChips"></div>
        </div>
        <div class="pill side-right" id="prevPill">Prev: â€”</div>
      </div>
    </div>

    <!-- 24-Hour Table -->
    <div class="card" id="hourTableCard">
      <div class="flex-between"><h2 style="margin:0;font-size:18px">24â€‘Hour Table</h2></div>
      <div style="overflow:auto">
        <table id="hourTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Startâ€“End</th>
              <th>Ruler</th>
              <th>Order</th>
              <th>Hour</th>
              <th>Hours ruled (B/D/T)</th>
              <th>Multiplier</th>
              <th>Focus</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 7Ã—7 Focus Matrix -->
    <div class="card" id="matrixCard">
      <div class="flex-between">
        <h2 style="margin:0;font-size:18px">7Ã—7 Focus Matrix</h2>
        <div class="row"><label>Filter:</label>
          <select id="matrixFilter">
            <option value="all">All</option>
            <option value="bright">Bright</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>
      <div class="matrix" style="margin-top:8px">
        <table id="matrixTable"><tbody></tbody></table>
      </div>
    </div>

    <!-- Weekly Bridge Hours -->
    <div class="card" id="bridgesCard">
      <h2 style="margin:0 0 8px;font-size:18px">Weekly Bridge Hours</h2>
      <div style="overflow:auto">
        <table id="bridgesTable">
          <thead>
            <tr>
              <th>Day (last hr)</th>
              <th>Multiplier</th>
              <th>Next day (first hr)</th>
              <th>Multiplier</th>
              <th>Î”</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Help / Tests -->
    <div class="card">
      <details>
        <summary>ðŸ”§ Builtâ€‘in tests</summary>
        <div class="testbar" style="margin-top:8px">
          <button id="runTestsBtn">Run tests</button>
          <div id="testOut" class="tiny mono"></div>
        </div>
      </details>
    </div>
  </div>

  <script>
  // Corrected frame computation
  function computeFrameAccurate(now, lat, lon, timeZone){
    const { y, m, d, hh, mm } = toLocalPartsInTZ(now, timeZone);
    const todayLocalNoon = fromLocalPartsInTZ(y, m-1, d, 12, 0, 0, timeZone);
    const yNoon = new Date(todayLocalNoon.getTime() - 86400000);
    const tNoon = new Date(todayLocalNoon.getTime() + 86400000);

    const yTimes = computeSunTimesLocal(yNoon, lat, lon, timeZone);
    const tTimes = computeSunTimesLocal(todayLocalNoon, lat, lon, timeZone);
    if(yTimes.polar || tTimes.polar){
      return { start: todayLocalNoon, end: new Date(todayLocalNoon.getTime()+86400000), sunrise: todayLocalNoon, sunset: todayLocalNoon, nextSunrise: new Date(todayLocalNoon.getTime()+86400000), dayRulerKey: DAY_RULERS[fromLocalPartsInTZ(y,m-1,d,0,0,0,timeZone).getDay()], polar:true };
    }
    const sr0 = yTimes.sunriseLocal, ss0 = yTimes.sunsetLocal;
    const sr1 = tTimes.sunriseLocal, ss1 = tTimes.sunsetLocal;
    const sr2 = computeSunTimesLocal(tNoon, lat, lon, timeZone).sunriseLocal;

    const nowLocal = fromLocalPartsInTZ(y, m-1, d, hh, mm, 0, timeZone);

    let frameStart, frameEnd, frameSunset;
    if(nowLocal >= sr1){
      frameStart = sr1; frameEnd = sr2; frameSunset = ss1;
    } else {
      frameStart = sr0; frameEnd = sr1; frameSunset = ss0;
    }

    const dayRulerKey = DAY_RULERS[ frameStart.getDay() ];
    return { start:frameStart, end:frameEnd, sunrise:sr1, sunset:frameSunset, nextSunrise:frameEnd, dayRulerKey, polar:false };
  }

function renderHero(){
  // Make sure we actually have a frame and 24 hours built
  if (!S.frame || !Array.isArray(S.hours) || S.hours.length !== 24) {
    // Leave placeholders visible, don't throw
    return;
  }

  const now = S.useSystem ? new Date() : S.dt;

  // Find the current hour; if not found but we're before next sunrise,
  // treat it as the last (24th) hour to avoid a boundary crash.
  let iNow = S.hours.findIndex(h => now >= h.start && now < h.end);
  if (iNow === -1 && now >= S.hours[23].end && now < S.frame.end) iNow = 23;

  // If still not found (shouldnâ€™t happen), bail safely
  if (iNow === -1) return;

  const curr = S.hours[iNow];
  const prev = S.hours[(iNow - 1 + 24) % 24];

  // --- Correct "Next" pill across the sunrise boundary ---
  let nextRulerKey, nextStart;
  if (curr.idx === 24) {
    // Next hour belongs to NEXT DAY's day ruler (Hour 1)
    nextRulerKey = DAY_RULERS[(S.frame.start.getDay() + 1) % 7];
    nextStart    = S.frame.end; // next sunrise
  } else {
    const nxt = S.hours[(iNow + 1) % 24];
    nextRulerKey = nxt.ruler;
    nextStart    = nxt.start;
  }

  const pr = PLANETS.find(p => p.key === prev.ruler);
  const cr = PLANETS.find(p => p.key === curr.ruler);
  const nx = PLANETS.find(p => p.key === nextRulerKey);
  if (!pr || !cr || !nx) return; // extra guard

  // Pills
  byId('currentPill').innerHTML = `${cr.symbol} <strong>${cr.name}</strong>`;
  byId('prevPill').innerHTML    = `Prev: ${pr.symbol} ${pr.name} â€¢ ends ${fmtHM(prev.end)}`;
  byId('nextPill').innerHTML    = `Next: ${nx.symbol} ${nx.name} â€¢ starts ${fmtHM(nextStart)}`;

  // Multiplier + meta
  byId('multiplier').textContent = 'x' + (curr.mult ?? 0).toFixed(3);
  byId('ordinalChip').textContent = ORDINALS[curr.ordinal] || `${curr.ordinal}th`;
  byId('metaLine').textContent =
    `Hour ${curr.idx}/24 â€¢ ${curr.isBright ? 'Bright' : 'Dark'} â€¢ ` +
    `Ruler appearance: ${curr.counts?.T ?? 0} of 24 today â€¢ ` +
    `Hours ruled B/D/T: ${curr.counts?.B ?? 0}/${curr.counts?.D ?? 0}/${curr.counts?.T ?? 0}`;

  // â€œApproaching sunriseâ€ line
  const nextDayRulerKey = DAY_RULERS[(S.frame.start.getDay()+1) % 7];
  const nextDay = PLANETS.find(p => p.key === nextDayRulerKey);
  byId('approachLine').textContent =
    curr.idx === 24
      ? `Approaching sunrise â†’ ${nextDay.symbol} ${nextDay.name} day`
      : `Next sunrise â†’ ${nextDay.symbol} ${nextDay.name} day`;

  // Legend chips
  const dr = PLANETS.find(p => p.key === S.frame.dayRulerKey);
  if (dr) {
    byId('legendChips').innerHTML =
      `<span class="pill" style="border-color:${dr.color}">${dr.symbol} ${dr.name} â€” ${dr.focusDay}</span>` +
      ` <span class="pill" style="border-color:${cr.color}">${cr.symbol} ${cr.name} â€” ${cr.focusHour}</span>`;
  }

  // Bridge Î” (Hour 24 -> Hour 1)
  const h24 = S.hours[23], h1 = S.hours[0];
  if (h24 && h1) {
    const delta = (h1.mult ?? 0) - (h24.mult ?? 0);
    const arrow = delta > 0 ? 'â†‘' : (delta < 0 ? 'â†“' : 'â†’');
    byId('bridgeLine').textContent =
      `${PLANETS.find(p=>p.key===h24.ruler).symbol} ${cap(h24.ruler)} (Hour 24) â†’ ` +
      `${PLANETS.find(p=>p.key===h1.ruler).symbol} ${cap(h1.ruler)} (Hour 1) ` +
      `Î” ${delta >= 0 ? '+' : ''}${delta.toFixed(3)} ${arrow}`;
  }

  layoutTickerMarkers();
}

  </script>
</body>
</html>
